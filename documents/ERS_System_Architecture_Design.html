<!DOCTYPE html>
<html>
<head>
<title>ERS_System_Architecture_Design.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="error-reporting-service-ers---system-architecture-design">Error Reporting Service (ERS) - System Architecture Design</h1>
<p><strong>Document Version:</strong> 1.0<br>
<strong>Date:</strong> August 7, 2025<br>
<strong>Author:</strong> Architecture Team<br>
<strong>Based on:</strong> ASR Error Reporting PRD - Error Reporting Service Component</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#ers-hexagonal-architecture">ERS Hexagonal Architecture</a></li>
<li><a href="#component-design">Component Design</a></li>
<li><a href="#api-specifications">API Specifications</a></li>
<li><a href="#data-architecture">Data Architecture</a></li>
<li><a href="#implementation-guidelines">Implementation Guidelines</a></li>
<li><a href="#testing-strategy">Testing Strategy</a></li>
</ol>
<hr>
<h2 id="1-executive-summary">1. Executive Summary</h2>
<h3 id="11-service-overview">1.1 Service Overview</h3>
<p>The Error Reporting Service (ERS) is the foundational component of the ASR Error Reporting and Correction System, responsible for capturing, validating, and processing error reports from QA personnel. Built using <strong>Hexagonal Architecture (Ports and Adapters)</strong> pattern with <strong>Python + FastAPI</strong>, ERS ensures clean separation between business logic and external dependencies while maintaining high testability and maintainability.</p>
<h3 id="12-key-responsibilities">1.2 Key Responsibilities</h3>
<ul>
<li><strong>Error Capture</strong>: Accept and validate error reports from QA personnel</li>
<li><strong>Data Validation</strong>: Ensure data integrity and business rule compliance</li>
<li><strong>Event Publishing</strong>: Notify other services of error events for downstream processing</li>
<li><strong>Audit Trail</strong>: Maintain complete audit logs for compliance and debugging</li>
</ul>
<h3 id="13-architecture-principles">1.3 Architecture Principles</h3>
<ol>
<li><strong>Hexagonal Architecture</strong>: Clear separation between business logic (core), interfaces (ports), and external adapters</li>
<li><strong>Domain-Driven Design</strong>: Business logic organized around error reporting domain concepts</li>
<li><strong>Event-Driven Communication</strong>: Loose coupling through asynchronous event messaging</li>
<li><strong>SOLID Principles</strong>: Maintainable, testable, and debuggable code structure</li>
<li><strong>Test-Driven Development</strong>: Comprehensive test coverage with isolated unit tests</li>
</ol>
<h3 id="14-technology-stack">1.4 Technology Stack</h3>
<ul>
<li><strong>Backend Framework</strong>: Python 3.11+ with FastAPI for high-performance async API development</li>
<li><strong>Data Validation</strong>: Pydantic 2.0+ for robust data modeling and validation</li>
<li><strong>Database Options</strong> (Configurable via Adapter Pattern):
<ul>
<li><strong>PostgreSQL</strong> 15+ with SQLAlchemy 2.0+ async ORM (Primary)</li>
<li><strong>SQL Server</strong> with SQLAlchemy async support</li>
<li><strong>MongoDB</strong> with Motor async driver</li>
</ul>
</li>
<li><strong>Message Queue Options</strong> (Configurable via Adapter Pattern):
<ul>
<li><strong>Apache Kafka</strong> with aiokafka (Primary)</li>
<li><strong>Azure Service Bus</strong> with azure-servicebus</li>
<li><strong>AWS SQS</strong> with aioboto3</li>
<li><strong>RabbitMQ</strong> with aio-pika</li>
</ul>
</li>
<li><strong>Testing</strong>: pytest with pytest-asyncio for comprehensive testing</li>
<li><strong>Monitoring</strong>: OpenTelemetry for observability and distributed tracing</li>
</ul>
<hr>
<h2 id="2-ers-hexagonal-architecture">2. ERS Hexagonal Architecture</h2>
<h3 id="21-ers-architecture-diagram">2.1 ERS Architecture Diagram</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TB
    %% External Actors
    subgraph "External Actors"
        QA[QA Personnel]
        ADMIN[System Admin]
    end

    %% External Systems
    subgraph "External Systems"
        RIS[RAG Integration Service]
        UMS[User Management Service]
        NOTIFICATION[Notification System]
    end

    %% API Gateway
    subgraph "Infrastructure Layer"
        API_GW[API Gateway<br/>Authentication<br/>Rate Limiting<br/>Request Routing]
    end

    %% Error Reporting Service - Hexagonal Architecture
    subgraph "Error Reporting Service (ERS)"
        %% Ports (Interfaces)
        subgraph "PORTS [Primary & Secondary Ports]"
            HTTP_PORT[HTTP API Port<br/>• Submit Error Report<br/>• Query Error Reports<br/>• Update Error Status]
            EVENT_PORT[Event Publishing Port<br/>• Error Reported Events<br/>• Error Updated Events<br/>• Error Deleted Events]
            VALIDATION_PORT[Validation Port<br/>• Business Rule Validation<br/>• Data Integrity Checks<br/>• Speaker/Job Validation]
            PERSISTENCE_PORT[Persistence Port<br/>• Error Storage<br/>• Audit Trail<br/>• Transaction Management]
        end
        
        %% Core Business Logic
        subgraph "CORE [Business Logic Domain]"
            DOMAIN[Error Report Domain<br/>• Error Entity<br/>• Validation Rules<br/>• Business Logic<br/>• Domain Events]
            USE_CASES[Use Cases<br/>• Submit Error Report<br/>• Validate Error Data<br/>• Process Error Context<br/>• Generate Audit Trail]
            SERVICES[Domain Services<br/>• Error Categorization<br/>• Severity Assessment<br/>• Context Processing<br/>• Quality Validation]
        end
        
        %% Adapters (External Integrations)
        subgraph "ADAPTERS [Infrastructure Adapters]"
            REST_ADAPTER[REST API Adapter<br/>FastAPI Controllers<br/>Request/Response Handling<br/>HTTP Status Management]

            subgraph "Event Bus Adapters"
                EVENT_INTERFACE[IEventBusAdapter<br/>Abstract Interface]
                KAFKA_ADAPTER[Kafka Adapter]
                AZURE_SB_ADAPTER[Azure Service Bus Adapter]
                AWS_SQS_ADAPTER[AWS SQS Adapter]
                RABBITMQ_ADAPTER[RabbitMQ Adapter]
            end

            subgraph "Database Adapters"
                DB_INTERFACE[IDatabaseAdapter<br/>Abstract Interface]
                POSTGRES_ADAPTER[PostgreSQL Adapter<br/>SQLAlchemy]
                SQLSERVER_ADAPTER[SQL Server Adapter<br/>SQLAlchemy]
                MONGODB_ADAPTER[MongoDB Adapter<br/>Motor]
            end

            EXTERNAL_ADAPTER[External Service Adapter<br/>Speaker Validation<br/>Job Verification<br/>User Authentication]
        end
    end

    %% Data Layer
    subgraph "Data Layer"
        RDB[(PostgreSQL<br/>Error Reports<br/>Audit Logs<br/>Metadata)]
        EVENT_BUS[(Kafka Event Bus<br/>Error Events<br/>Async Processing)]
        CACHE[(Redis Cache<br/>Validation Cache<br/>Session Data)]
    end

    %% Connections - External to API Gateway
    QA --> API_GW
    ADMIN --> API_GW

    %% API Gateway to Ports
    API_GW --> HTTP_PORT

    %% Port to Core connections
    HTTP_PORT --> USE_CASES
    EVENT_PORT --> USE_CASES
    VALIDATION_PORT --> USE_CASES
    PERSISTENCE_PORT --> USE_CASES

    %% Use Cases to Domain
    USE_CASES --> DOMAIN
    USE_CASES --> SERVICES

    %% Core to Adapter Interface connections
    DOMAIN --> REST_ADAPTER
    DOMAIN --> EVENT_INTERFACE
    DOMAIN --> DB_INTERFACE
    DOMAIN --> EXTERNAL_ADAPTER

    %% Abstract Interface to Concrete Adapter connections
    EVENT_INTERFACE --> KAFKA_ADAPTER
    EVENT_INTERFACE --> AZURE_SB_ADAPTER
    EVENT_INTERFACE --> AWS_SQS_ADAPTER
    EVENT_INTERFACE --> RABBITMQ_ADAPTER

    DB_INTERFACE --> POSTGRES_ADAPTER
    DB_INTERFACE --> SQLSERVER_ADAPTER
    DB_INTERFACE --> MONGODB_ADAPTER

    %% Adapter to External System connections
    REST_ADAPTER --> API_GW
    KAFKA_ADAPTER --> EVENT_BUS
    POSTGRES_ADAPTER --> RDB
    EXTERNAL_ADAPTER --> UMS
    EXTERNAL_ADAPTER --> CACHE

    %% Event Bus to External Services
    EVENT_BUS -.->|Error Reported Event| RIS
    EVENT_BUS -.->|Notification Event| NOTIFICATION

    %% Styling
    classDef coreLogic fill:#e8f5e8,stroke:#4caf50,stroke-width:3px
    classDef ports fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef adapters fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    classDef external fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px

    class CORE coreLogic
    class PORTS ports
    class ADAPTERS adapters
    class RDB,EVENT_BUS,CACHE database
    class RIS,UMS,NOTIFICATION external
</div></code></pre>
<h3 id="22-architecture-benefits">2.2 Architecture Benefits</h3>
<ol>
<li><strong>Independent Development</strong>: Business logic isolated from external dependencies</li>
<li><strong>High Testability</strong>: Core domain can be tested without external systems</li>
<li><strong>Flexibility</strong>: Easy to swap adapters without affecting business logic</li>
<li><strong>Maintainability</strong>: Clear separation of concerns and well-defined boundaries</li>
<li><strong>Scalability</strong>: Stateless design enables horizontal scaling</li>
</ol>
<hr>
<h2 id="3-component-design">3. Component Design</h2>
<h3 id="31-core-domain-components">3.1 Core Domain Components</h3>
<h4 id="311-error-report-entity">3.1.1 Error Report Entity</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field, validator
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Optional, Dict, Any
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> UUID

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeverityLevel</span><span class="hljs-params">(str, Enum)</span>:</span>
    LOW = <span class="hljs-string">"low"</span>
    MEDIUM = <span class="hljs-string">"medium"</span>
    HIGH = <span class="hljs-string">"high"</span>
    CRITICAL = <span class="hljs-string">"critical"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorStatus</span><span class="hljs-params">(str, Enum)</span>:</span>
    PENDING = <span class="hljs-string">"pending"</span>
    PROCESSED = <span class="hljs-string">"processed"</span>
    ARCHIVED = <span class="hljs-string">"archived"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorReport</span><span class="hljs-params">(BaseModel)</span>:</span>
    <span class="hljs-string">"""Core Error Report Entity - Domain Model"""</span>
    error_id: UUID
    job_id: UUID
    speaker_id: UUID
    reported_by: UUID
    original_text: str = Field(..., min_length=<span class="hljs-number">1</span>, max_length=<span class="hljs-number">5000</span>)
    corrected_text: str = Field(..., min_length=<span class="hljs-number">1</span>, max_length=<span class="hljs-number">5000</span>)
    error_categories: List[str] = Field(..., min_items=<span class="hljs-number">1</span>)
    severity_level: SeverityLevel
    start_position: int = Field(..., ge=<span class="hljs-number">0</span>)
    end_position: int = Field(..., ge=<span class="hljs-number">0</span>)
    context_notes: Optional[str] = Field(<span class="hljs-literal">None</span>, max_length=<span class="hljs-number">2000</span>)
    error_timestamp: datetime
    reported_at: datetime
    status: ErrorStatus = ErrorStatus.PENDING
    metadata: Dict[str, Any] = Field(default_factory=dict)

<span class="hljs-meta">    @validator('end_position')</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_position_range</span><span class="hljs-params">(cls, v, values)</span>:</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'start_position'</span> <span class="hljs-keyword">in</span> values <span class="hljs-keyword">and</span> v &lt;= values[<span class="hljs-string">'start_position'</span>]:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'end_position must be greater than start_position'</span>)
        <span class="hljs-keyword">return</span> v

<span class="hljs-meta">    @validator('corrected_text')</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_correction_differs</span><span class="hljs-params">(cls, v, values)</span>:</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'original_text'</span> <span class="hljs-keyword">in</span> values <span class="hljs-keyword">and</span> v == values[<span class="hljs-string">'original_text'</span>]:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'corrected_text must differ from original_text'</span>)
        <span class="hljs-keyword">return</span> v
</div></code></pre>
<h4 id="312-domain-services">3.1.2 Domain Services</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorValidationService</span>:</span>
    <span class="hljs-string">"""Domain service for error validation business logic"""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_error_categories</span><span class="hljs-params">(self, categories: List[str])</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate error categories against business rules"""</span>
        valid_categories = {
            <span class="hljs-string">"pronunciation"</span>, <span class="hljs-string">"medical_terminology"</span>, <span class="hljs-string">"grammar"</span>, 
            <span class="hljs-string">"context"</span>, <span class="hljs-string">"speaker_specific"</span>, <span class="hljs-string">"audio_quality"</span>
        }
        <span class="hljs-keyword">return</span> all(cat <span class="hljs-keyword">in</span> valid_categories <span class="hljs-keyword">for</span> cat <span class="hljs-keyword">in</span> categories)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">assess_severity</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; SeverityLevel:</span>
        <span class="hljs-string">"""Business logic for severity assessment"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"medical_terminology"</span> <span class="hljs-keyword">in</span> error_report.error_categories:
            <span class="hljs-keyword">return</span> SeverityLevel.HIGH
        <span class="hljs-keyword">if</span> len(error_report.original_text) &gt; <span class="hljs-number">100</span>:
            <span class="hljs-keyword">return</span> SeverityLevel.MEDIUM
        <span class="hljs-keyword">return</span> SeverityLevel.LOW
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_context_integrity</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate error context and position integrity"""</span>
        text_length = len(error_report.original_text)
        <span class="hljs-keyword">return</span> (
            error_report.start_position &lt; text_length <span class="hljs-keyword">and</span>
            error_report.end_position &lt;= text_length <span class="hljs-keyword">and</span>
            error_report.start_position &gt;= <span class="hljs-number">0</span>
        )

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorCategorizationService</span>:</span>
    <span class="hljs-string">"""Domain service for error categorization logic"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">suggest_categories</span><span class="hljs-params">(self, original_text: str, corrected_text: str)</span> -&gt; List[str]:</span>
        <span class="hljs-string">"""AI-powered category suggestion based on text analysis"""</span>
        <span class="hljs-comment"># Implementation would include ML-based categorization</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_category_combinations</span><span class="hljs-params">(self, categories: List[str])</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate that category combinations make business sense"""</span>
        <span class="hljs-comment"># Business rules for valid category combinations</span>
        <span class="hljs-keyword">pass</span>
</div></code></pre>
<h3 id="32-use-cases-application-layer">3.2 Use Cases (Application Layer)</h3>
<h4 id="321-submit-error-report-use-case">3.2.1 Submit Error Report Use Case</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Protocol

<span class="hljs-meta">@dataclass</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubmitErrorReportRequest</span>:</span>
    job_id: str
    speaker_id: str
    original_text: str
    corrected_text: str
    error_categories: List[str]
    severity_level: str
    start_position: int
    end_position: int
    context_notes: Optional[str]
    reported_by: str
    metadata: Dict[str, Any]

<span class="hljs-meta">@dataclass</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubmitErrorReportResponse</span>:</span>
    error_id: str
    status: str
    message: str
    validation_warnings: List[str]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorReportRepository</span><span class="hljs-params">(Protocol)</span>:</span>
    <span class="hljs-string">"""Repository interface for error report persistence"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        ...

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        ...

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_speaker</span><span class="hljs-params">(self, speaker_id: UUID)</span> -&gt; List[ErrorReport]:</span>
        ...

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventPublisher</span><span class="hljs-params">(Protocol)</span>:</span>
    <span class="hljs-string">"""Event publishing interface"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_error_reported</span><span class="hljs-params">(self, event: ErrorReportedEvent)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        ...

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubmitErrorReportUseCase</span>:</span>
    <span class="hljs-string">"""Use case for submitting error reports"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(
        self,
        repository: ErrorReportRepository,
        event_publisher: EventPublisher,
        validation_service: ErrorValidationService,
        categorization_service: ErrorCategorizationService
    )</span>:</span>
        self._repository = repository
        self._event_publisher = event_publisher
        self._validation_service = validation_service
        self._categorization_service = categorization_service

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span><span class="hljs-params">(self, request: SubmitErrorReportRequest)</span> -&gt; SubmitErrorReportResponse:</span>
        <span class="hljs-string">"""Execute the submit error report use case"""</span>

        <span class="hljs-comment"># 1. Create domain entity</span>
        error_report = ErrorReport(
            error_id=UUID4(),
            job_id=UUID(request.job_id),
            speaker_id=UUID(request.speaker_id),
            reported_by=UUID(request.reported_by),
            original_text=request.original_text,
            corrected_text=request.corrected_text,
            error_categories=request.error_categories,
            severity_level=SeverityLevel(request.severity_level),
            start_position=request.start_position,
            end_position=request.end_position,
            context_notes=request.context_notes,
            error_timestamp=datetime.utcnow(),
            reported_at=datetime.utcnow(),
            metadata=request.metadata
        )

        <span class="hljs-comment"># 2. Validate business rules</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validation_service.validate_error_categories(error_report.error_categories):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Invalid error categories"</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validation_service.validate_context_integrity(error_report):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Invalid error context or position"</span>)

        <span class="hljs-comment"># 3. Persist error report</span>
        saved_error = <span class="hljs-keyword">await</span> self._repository.save(error_report)

        <span class="hljs-comment"># 4. Publish domain event</span>
        event = ErrorReportedEvent(
            error_id=str(saved_error.error_id),
            speaker_id=str(saved_error.speaker_id),
            job_id=str(saved_error.job_id),
            original_text=saved_error.original_text,
            corrected_text=saved_error.corrected_text,
            categories=saved_error.error_categories,
            severity=saved_error.severity_level.value,
            timestamp=saved_error.reported_at
        )

        <span class="hljs-keyword">await</span> self._event_publisher.publish_error_reported(event)

        <span class="hljs-keyword">return</span> SubmitErrorReportResponse(
            error_id=str(saved_error.error_id),
            status=<span class="hljs-string">"success"</span>,
            message=<span class="hljs-string">"Error report submitted successfully"</span>,
            validation_warnings=[]
        )
</div></code></pre>
<h3 id="33-port-interfaces">3.3 Port Interfaces</h3>
<h4 id="331-primary-ports-driving-adapters">3.3.1 Primary Ports (Driving Adapters)</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorReportingPort</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Primary port for error reporting operations"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">submit_error_report</span><span class="hljs-params">(self, request: SubmitErrorReportRequest)</span> -&gt; SubmitErrorReportResponse:</span>
        <span class="hljs-string">"""Submit a new error report"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_error_report</span><span class="hljs-params">(self, error_id: str)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Retrieve error report by ID"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_error_report</span><span class="hljs-params">(self, error_id: str, updates: Dict[str, Any])</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Update existing error report"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_errors_by_speaker</span><span class="hljs-params">(self, speaker_id: str, filters: Optional[Dict] = None)</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Get all errors for a specific speaker"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search_errors</span><span class="hljs-params">(self, query: Dict[str, Any])</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Search errors with complex criteria"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment">#### 3.3.2 Secondary Ports (Driven Adapters)</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidationPort</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Secondary port for validation operations"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_speaker_exists</span><span class="hljs-params">(self, speaker_id: str)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate that speaker exists in the system"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_job_exists</span><span class="hljs-params">(self, job_id: str)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate that job exists in the system"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_user_permissions</span><span class="hljs-params">(self, user_id: str, operation: str)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Validate user has permissions for operation"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventPublishingPort</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Secondary port for event publishing"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_error_reported</span><span class="hljs-params">(self, event: ErrorReportedEvent)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Publish error reported event"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_error_updated</span><span class="hljs-params">(self, event: ErrorUpdatedEvent)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Publish error updated event"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment">### 3.4 Abstract Adapter Interfaces</span>

<span class="hljs-comment">#### 3.4.1 Database Adapter Interface</span>
```python
<span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Optional, Dict, Any
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> UUID

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IDatabaseAdapter</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Abstract interface for database operations - technology agnostic"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_error_report</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Save error report to database"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_error_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        <span class="hljs-string">"""Find error report by ID"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_errors_by_speaker</span><span class="hljs-params">(self, speaker_id: UUID, filters: Optional[Dict] = None)</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Find all error reports for a speaker"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_error_report</span><span class="hljs-params">(self, error_id: UUID, updates: Dict[str, Any])</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Update existing error report"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_error_report</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Delete error report"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search_errors</span><span class="hljs-params">(self, query: Dict[str, Any])</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Search errors with complex criteria"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">begin_transaction</span><span class="hljs-params">(self)</span> -&gt; Any:</span>
        <span class="hljs-string">"""Begin database transaction"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commit_transaction</span><span class="hljs-params">(self, transaction: Any)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Commit database transaction"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rollback_transaction</span><span class="hljs-params">(self, transaction: Any)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Rollback database transaction"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment">#### 3.4.2 Event Bus Adapter Interface</span>
```python
<span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any, Optional
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageDeliveryMode</span><span class="hljs-params">(str, Enum)</span>:</span>
    AT_MOST_ONCE = <span class="hljs-string">"at_most_once"</span>
    AT_LEAST_ONCE = <span class="hljs-string">"at_least_once"</span>
    EXACTLY_ONCE = <span class="hljs-string">"exactly_once"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventMetadata</span><span class="hljs-params">(BaseModel)</span>:</span>
    correlation_id: Optional[str] = <span class="hljs-literal">None</span>
    delivery_mode: MessageDeliveryMode = MessageDeliveryMode.AT_LEAST_ONCE
    retry_count: int = <span class="hljs-number">0</span>
    max_retries: int = <span class="hljs-number">3</span>
    timeout_seconds: int = <span class="hljs-number">30</span>
    headers: Dict[str, str] = Field(default_factory=dict)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IEventBusAdapter</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Abstract interface for event bus operations - messaging system agnostic"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_event</span><span class="hljs-params">(
        self,
        topic: str,
        event: BaseEvent,
        metadata: Optional[EventMetadata] = None
    )</span> -&gt; bool:</span>
        <span class="hljs-string">"""Publish event to specified topic"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe_to_topic</span><span class="hljs-params">(
        self,
        topic: str,
        handler: callable,
        consumer_group: Optional[str] = None
    )</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Subscribe to topic with event handler"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_topic</span><span class="hljs-params">(self, topic: str, config: Optional[Dict[str, Any]] = None)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Create topic if it doesn't exist"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">health_check</span><span class="hljs-params">(self)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Check if event bus is healthy"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_connection_info</span><span class="hljs-params">(self)</span> -&gt; Dict[str, Any]:</span>
        <span class="hljs-string">"""Get connection information for monitoring"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment">### 3.5 Concrete Database Adapter Implementations</span>

<span class="hljs-comment">#### 3.5.1 PostgreSQL Adapter Implementation</span>
```python
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession, create_async_engine
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, update, delete
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Optional, Dict, Any

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgreSQLAdapter</span><span class="hljs-params">(IDatabaseAdapter)</span>:</span>
    <span class="hljs-string">"""PostgreSQL implementation of database adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, connection_string: str)</span>:</span>
        self.engine = create_async_engine(connection_string)
        self.session_factory = async_sessionmaker(self.engine)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_error_report</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Save error report to PostgreSQL"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.session_factory() <span class="hljs-keyword">as</span> session:
            model = ErrorReportModel(
                error_id=error_report.error_id,
                job_id=error_report.job_id,
                speaker_id=error_report.speaker_id,
                reported_by=error_report.reported_by,
                original_text=error_report.original_text,
                corrected_text=error_report.corrected_text,
                error_categories=error_report.error_categories,
                severity_level=error_report.severity_level.value,
                start_position=error_report.start_position,
                end_position=error_report.end_position,
                context_notes=error_report.context_notes,
                error_timestamp=error_report.error_timestamp,
                reported_at=error_report.reported_at,
                status=error_report.status.value,
                metadata=error_report.metadata
            )

            session.add(model)
            <span class="hljs-keyword">await</span> session.commit()
            <span class="hljs-keyword">await</span> session.refresh(model)

            <span class="hljs-keyword">return</span> self._model_to_entity(model)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_error_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        <span class="hljs-string">"""Find error report by ID in PostgreSQL"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.session_factory() <span class="hljs-keyword">as</span> session:
            stmt = select(ErrorReportModel).where(ErrorReportModel.error_id == error_id)
            result = <span class="hljs-keyword">await</span> session.execute(stmt)
            model = result.scalar_one_or_none()

            <span class="hljs-keyword">return</span> self._model_to_entity(model) <span class="hljs-keyword">if</span> model <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">begin_transaction</span><span class="hljs-params">(self)</span> -&gt; AsyncSession:</span>
        <span class="hljs-string">"""Begin PostgreSQL transaction"""</span>
        session = self.session_factory()
        <span class="hljs-keyword">await</span> session.begin()
        <span class="hljs-keyword">return</span> session

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commit_transaction</span><span class="hljs-params">(self, transaction: AsyncSession)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Commit PostgreSQL transaction"""</span>
        <span class="hljs-keyword">await</span> transaction.commit()
        <span class="hljs-keyword">await</span> transaction.close()

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rollback_transaction</span><span class="hljs-params">(self, transaction: AsyncSession)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Rollback PostgreSQL transaction"""</span>
        <span class="hljs-keyword">await</span> transaction.rollback()
        <span class="hljs-keyword">await</span> transaction.close()

<span class="hljs-comment">#### 3.5.2 MongoDB Adapter Implementation</span>
```python
<span class="hljs-keyword">from</span> motor.motor_asyncio <span class="hljs-keyword">import</span> AsyncIOMotorClient, AsyncIOMotorDatabase
<span class="hljs-keyword">from</span> bson <span class="hljs-keyword">import</span> ObjectId
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoDBAdapter</span><span class="hljs-params">(IDatabaseAdapter)</span>:</span>
    <span class="hljs-string">"""MongoDB implementation of database adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, connection_string: str, database_name: str)</span>:</span>
        self.client = AsyncIOMotorClient(connection_string)
        self.database: AsyncIOMotorDatabase = self.client[database_name]
        self.collection = self.database.error_reports

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_error_report</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Save error report to MongoDB"""</span>
        document = {
            <span class="hljs-string">"_id"</span>: str(error_report.error_id),
            <span class="hljs-string">"job_id"</span>: str(error_report.job_id),
            <span class="hljs-string">"speaker_id"</span>: str(error_report.speaker_id),
            <span class="hljs-string">"reported_by"</span>: str(error_report.reported_by),
            <span class="hljs-string">"original_text"</span>: error_report.original_text,
            <span class="hljs-string">"corrected_text"</span>: error_report.corrected_text,
            <span class="hljs-string">"error_categories"</span>: error_report.error_categories,
            <span class="hljs-string">"severity_level"</span>: error_report.severity_level.value,
            <span class="hljs-string">"start_position"</span>: error_report.start_position,
            <span class="hljs-string">"end_position"</span>: error_report.end_position,
            <span class="hljs-string">"context_notes"</span>: error_report.context_notes,
            <span class="hljs-string">"error_timestamp"</span>: error_report.error_timestamp,
            <span class="hljs-string">"reported_at"</span>: error_report.reported_at,
            <span class="hljs-string">"status"</span>: error_report.status.value,
            <span class="hljs-string">"metadata"</span>: error_report.metadata,
            <span class="hljs-string">"created_at"</span>: datetime.utcnow(),
            <span class="hljs-string">"updated_at"</span>: datetime.utcnow()
        }

        <span class="hljs-keyword">await</span> self.collection.insert_one(document)
        <span class="hljs-keyword">return</span> error_report

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_error_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        <span class="hljs-string">"""Find error report by ID in MongoDB"""</span>
        document = <span class="hljs-keyword">await</span> self.collection.find_one({<span class="hljs-string">"_id"</span>: str(error_id)})

        <span class="hljs-keyword">return</span> self._document_to_entity(document) <span class="hljs-keyword">if</span> document <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_errors_by_speaker</span><span class="hljs-params">(self, speaker_id: UUID, filters: Optional[Dict] = None)</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Find all error reports for a speaker in MongoDB"""</span>
        query = {<span class="hljs-string">"speaker_id"</span>: str(speaker_id)}

        <span class="hljs-keyword">if</span> filters:
            <span class="hljs-keyword">if</span> <span class="hljs-string">"severity_level"</span> <span class="hljs-keyword">in</span> filters:
                query[<span class="hljs-string">"severity_level"</span>] = filters[<span class="hljs-string">"severity_level"</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">"status"</span> <span class="hljs-keyword">in</span> filters:
                query[<span class="hljs-string">"status"</span>] = filters[<span class="hljs-string">"status"</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">"categories"</span> <span class="hljs-keyword">in</span> filters:
                query[<span class="hljs-string">"error_categories"</span>] = {<span class="hljs-string">"$in"</span>: filters[<span class="hljs-string">"categories"</span>]}

        cursor = self.collection.find(query)
        documents = <span class="hljs-keyword">await</span> cursor.to_list(length=<span class="hljs-literal">None</span>)

        <span class="hljs-keyword">return</span> [self._document_to_entity(doc) <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents]

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">begin_transaction</span><span class="hljs-params">(self)</span> -&gt; Any:</span>
        <span class="hljs-string">"""Begin MongoDB transaction"""</span>
        session = <span class="hljs-keyword">await</span> self.client.start_session()
        session.start_transaction()
        <span class="hljs-keyword">return</span> session

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commit_transaction</span><span class="hljs-params">(self, transaction: Any)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Commit MongoDB transaction"""</span>
        <span class="hljs-keyword">await</span> transaction.commit_transaction()
        <span class="hljs-keyword">await</span> transaction.end_session()

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rollback_transaction</span><span class="hljs-params">(self, transaction: Any)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Rollback MongoDB transaction"""</span>
        <span class="hljs-keyword">await</span> transaction.abort_transaction()
        <span class="hljs-keyword">await</span> transaction.end_session()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_document_to_entity</span><span class="hljs-params">(self, document: Dict)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Convert MongoDB document to domain entity"""</span>
        <span class="hljs-keyword">return</span> ErrorReport(
            error_id=UUID(document[<span class="hljs-string">"_id"</span>]),
            job_id=UUID(document[<span class="hljs-string">"job_id"</span>]),
            speaker_id=UUID(document[<span class="hljs-string">"speaker_id"</span>]),
            reported_by=UUID(document[<span class="hljs-string">"reported_by"</span>]),
            original_text=document[<span class="hljs-string">"original_text"</span>],
            corrected_text=document[<span class="hljs-string">"corrected_text"</span>],
            error_categories=document[<span class="hljs-string">"error_categories"</span>],
            severity_level=SeverityLevel(document[<span class="hljs-string">"severity_level"</span>]),
            start_position=document[<span class="hljs-string">"start_position"</span>],
            end_position=document[<span class="hljs-string">"end_position"</span>],
            context_notes=document.get(<span class="hljs-string">"context_notes"</span>),
            error_timestamp=document[<span class="hljs-string">"error_timestamp"</span>],
            reported_at=document[<span class="hljs-string">"reported_at"</span>],
            status=ErrorStatus(document[<span class="hljs-string">"status"</span>]),
            metadata=document.get(<span class="hljs-string">"metadata"</span>, {})
        )

<span class="hljs-comment">### 3.6 Concrete Event Bus Adapter Implementations</span>

<span class="hljs-comment">#### 3.6.1 Kafka Adapter Implementation</span>
```python
<span class="hljs-keyword">from</span> aiokafka <span class="hljs-keyword">import</span> AIOKafkaProducer, AIOKafkaConsumer
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any, Optional

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaAdapter</span><span class="hljs-params">(IEventBusAdapter)</span>:</span>
    <span class="hljs-string">"""Apache Kafka implementation of event bus adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, bootstrap_servers: str, client_id: str = <span class="hljs-string">"ers-service"</span>)</span>:</span>
        self.bootstrap_servers = bootstrap_servers
        self.client_id = client_id
        self.producer = <span class="hljs-literal">None</span>
        self.consumers = {}

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_event</span><span class="hljs-params">(
        self,
        topic: str,
        event: BaseEvent,
        metadata: Optional[EventMetadata] = None
    )</span> -&gt; bool:</span>
        <span class="hljs-string">"""Publish event to Kafka topic"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.producer:
            self.producer = AIOKafkaProducer(
                bootstrap_servers=self.bootstrap_servers,
                client_id=self.client_id,
                value_serializer=<span class="hljs-keyword">lambda</span> v: json.dumps(v).encode(<span class="hljs-string">'utf-8'</span>)
            )
            <span class="hljs-keyword">await</span> self.producer.start()

        <span class="hljs-keyword">try</span>:
            event_data = event.dict()
            <span class="hljs-keyword">if</span> metadata:
                event_data[<span class="hljs-string">"_metadata"</span>] = metadata.dict()

            <span class="hljs-keyword">await</span> self.producer.send_and_wait(topic, event_data)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># Log error</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe_to_topic</span><span class="hljs-params">(
        self,
        topic: str,
        handler: callable,
        consumer_group: Optional[str] = None
    )</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Subscribe to Kafka topic with event handler"""</span>
        consumer = AIOKafkaConsumer(
            topic,
            bootstrap_servers=self.bootstrap_servers,
            group_id=consumer_group <span class="hljs-keyword">or</span> <span class="hljs-string">f"<span class="hljs-subst">{self.client_id}</span>-group"</span>,
            value_deserializer=<span class="hljs-keyword">lambda</span> m: json.loads(m.decode(<span class="hljs-string">'utf-8'</span>))
        )

        <span class="hljs-keyword">await</span> consumer.start()
        self.consumers[topic] = consumer

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> consumer:
                <span class="hljs-keyword">await</span> handler(message.value)
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-keyword">await</span> consumer.stop()

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">health_check</span><span class="hljs-params">(self)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Check Kafka cluster health"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.producer:
                test_producer = AIOKafkaProducer(
                    bootstrap_servers=self.bootstrap_servers,
                    client_id=<span class="hljs-string">f"<span class="hljs-subst">{self.client_id}</span>-health"</span>
                )
                <span class="hljs-keyword">await</span> test_producer.start()
                <span class="hljs-keyword">await</span> test_producer.stop()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment">#### 3.6.2 Azure Service Bus Adapter Implementation</span>
```python
<span class="hljs-keyword">from</span> azure.servicebus.aio <span class="hljs-keyword">import</span> ServiceBusClient, ServiceBusSender, ServiceBusReceiver
<span class="hljs-keyword">import</span> json

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AzureServiceBusAdapter</span><span class="hljs-params">(IEventBusAdapter)</span>:</span>
    <span class="hljs-string">"""Azure Service Bus implementation of event bus adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, connection_string: str)</span>:</span>
        self.connection_string = connection_string
        self.client = ServiceBusClient.from_connection_string(connection_string)
        self.senders = {}
        self.receivers = {}

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_event</span><span class="hljs-params">(
        self,
        topic: str,
        event: BaseEvent,
        metadata: Optional[EventMetadata] = None
    )</span> -&gt; bool:</span>
        <span class="hljs-string">"""Publish event to Service Bus topic"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.senders:
                self.senders[topic] = self.client.get_topic_sender(topic_name=topic)

            sender = self.senders[topic]

            event_data = event.dict()
            <span class="hljs-keyword">if</span> metadata:
                event_data[<span class="hljs-string">"_metadata"</span>] = metadata.dict()

            message = ServiceBusMessage(
                body=json.dumps(event_data),
                content_type=<span class="hljs-string">"application/json"</span>
            )

            <span class="hljs-keyword">if</span> metadata <span class="hljs-keyword">and</span> metadata.correlation_id:
                message.correlation_id = metadata.correlation_id

            <span class="hljs-keyword">await</span> sender.send_messages(message)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># Log error</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe_to_topic</span><span class="hljs-params">(
        self,
        topic: str,
        handler: callable,
        consumer_group: Optional[str] = None
    )</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""Subscribe to Service Bus topic with event handler"""</span>
        subscription_name = consumer_group <span class="hljs-keyword">or</span> <span class="hljs-string">"default-subscription"</span>

        receiver = self.client.get_subscription_receiver(
            topic_name=topic,
            subscription_name=subscription_name
        )

        self.receivers[<span class="hljs-string">f"<span class="hljs-subst">{topic}</span>-<span class="hljs-subst">{subscription_name}</span>"</span>] = receiver

        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receiver:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> receiver:
                <span class="hljs-keyword">try</span>:
                    event_data = json.loads(str(message))
                    <span class="hljs-keyword">await</span> handler(event_data)
                    <span class="hljs-keyword">await</span> receiver.complete_message(message)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-comment"># Log error and abandon message</span>
                    <span class="hljs-keyword">await</span> receiver.abandon_message(message)

<span class="hljs-comment">#### 3.6.3 AWS SQS Adapter Implementation</span>
```python
<span class="hljs-keyword">import</span> aioboto3
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Any, Optional

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AWSSQSAdapter</span><span class="hljs-params">(IEventBusAdapter)</span>:</span>
    <span class="hljs-string">"""AWS SQS implementation of event bus adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, region_name: str, access_key_id: str, secret_access_key: str)</span>:</span>
        self.region_name = region_name
        self.access_key_id = access_key_id
        self.secret_access_key = secret_access_key
        self.session = aioboto3.Session()
        self.queue_urls = {}

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_event</span><span class="hljs-params">(
        self,
        topic: str,
        event: BaseEvent,
        metadata: Optional[EventMetadata] = None
    )</span> -&gt; bool:</span>
        <span class="hljs-string">"""Publish event to SQS queue"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.session.client(
                <span class="hljs-string">'sqs'</span>,
                region_name=self.region_name,
                aws_access_key_id=self.access_key_id,
                aws_secret_access_key=self.secret_access_key
            ) <span class="hljs-keyword">as</span> sqs:

                <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.queue_urls:
                    response = <span class="hljs-keyword">await</span> sqs.get_queue_url(QueueName=topic)
                    self.queue_urls[topic] = response[<span class="hljs-string">'QueueUrl'</span>]

                event_data = event.dict()
                <span class="hljs-keyword">if</span> metadata:
                    event_data[<span class="hljs-string">"_metadata"</span>] = metadata.dict()

                message_attributes = {}
                <span class="hljs-keyword">if</span> metadata <span class="hljs-keyword">and</span> metadata.correlation_id:
                    message_attributes[<span class="hljs-string">'CorrelationId'</span>] = {
                        <span class="hljs-string">'StringValue'</span>: metadata.correlation_id,
                        <span class="hljs-string">'DataType'</span>: <span class="hljs-string">'String'</span>
                    }

                <span class="hljs-keyword">await</span> sqs.send_message(
                    QueueUrl=self.queue_urls[topic],
                    MessageBody=json.dumps(event_data),
                    MessageAttributes=message_attributes
                )
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># Log error</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">health_check</span><span class="hljs-params">(self)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Check SQS service health"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.session.client(
                <span class="hljs-string">'sqs'</span>,
                region_name=self.region_name,
                aws_access_key_id=self.access_key_id,
                aws_secret_access_key=self.secret_access_key
            ) <span class="hljs-keyword">as</span> sqs:
                <span class="hljs-keyword">await</span> sqs.list_queues()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</div></code></pre>
<pre class="hljs"><code><div></div></code></pre>
<hr>
<h2 id="4-api-specifications">4. API Specifications</h2>
<h3 id="41-error-reporting-api-workflow">4.1 Error Reporting API Workflow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant QA as QA User
    participant UI as Error Reporting UI
    participant API as API Gateway
    participant ERS as Error Reporting Service
    participant DB as PostgreSQL
    participant EVENT as Event Bus
    participant RIS as RAG Integration Service

    QA->>UI: Select error text and provide correction
    UI->>UI: Validate input data locally
    UI->>API: POST /api/v1/errors/report

    API->>API: Authenticate user token
    API->>API: Rate limit check
    API->>ERS: Forward error report request

    ERS->>ERS: Validate business rules
    ERS->>DB: Validate speaker and job IDs
    DB-->>ERS: Return validation results

    alt Validation successful
        ERS->>DB: Begin transaction
        ERS->>DB: Save error report
        ERS->>DB: Create audit log entry
        ERS->>DB: Commit transaction
        DB-->>ERS: Confirm persistence

        ERS->>EVENT: Publish ErrorReportedEvent
        EVENT-->>ERS: Confirm event published

        ERS-->>API: Return 201 Created with error_id
        API-->>UI: Return success response
        UI-->>QA: Display success confirmation

        EVENT->>RIS: Process error for vector embedding
        RIS-->>EVENT: Acknowledge processing

    else Validation failed
        ERS-->>API: Return 400 Bad Request
        API-->>UI: Return validation errors
        UI-->>QA: Display error messages with corrections
    end

    Note over QA,RIS: Error successfully captured and queued for ML processing
</div></code></pre>
<h3 id="42-rest-api-endpoints">4.2 REST API Endpoints</h3>
<h4 id="421-submit-error-report">4.2.1 Submit Error Report</h4>
<pre class="hljs"><code><div><span class="hljs-attribute">POST /api/v1/errors/report
Content-Type</span>: application/json
<span class="hljs-attribute">Authorization</span>: Bearer {jwt_token}

<span class="json">{
  <span class="hljs-attr">"job_id"</span>: <span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>,
  <span class="hljs-attr">"speaker_id"</span>: <span class="hljs-string">"550e8400-e29b-41d4-a716-446655440001"</span>,
  <span class="hljs-attr">"original_text"</span>: <span class="hljs-string">"The patient has a history of diabetis"</span>,
  <span class="hljs-attr">"corrected_text"</span>: <span class="hljs-string">"The patient has a history of diabetes"</span>,
  <span class="hljs-attr">"error_categories"</span>: [<span class="hljs-string">"medical_terminology"</span>, <span class="hljs-string">"spelling"</span>],
  <span class="hljs-attr">"severity_level"</span>: <span class="hljs-string">"high"</span>,
  <span class="hljs-attr">"start_position"</span>: <span class="hljs-number">32</span>,
  <span class="hljs-attr">"end_position"</span>: <span class="hljs-number">40</span>,
  <span class="hljs-attr">"context_notes"</span>: <span class="hljs-string">"Common misspelling of diabetes"</span>,
  <span class="hljs-attr">"metadata"</span>: {
    <span class="hljs-attr">"audio_quality"</span>: <span class="hljs-string">"good"</span>,
    <span class="hljs-attr">"background_noise"</span>: <span class="hljs-string">"low"</span>,
    <span class="hljs-attr">"confidence_score"</span>: <span class="hljs-number">0.95</span>
  }
}
</span></div></code></pre>
<p><strong>Response (201 Created):</strong></p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"success"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"error_id"</span>: <span class="hljs-string">"550e8400-e29b-41d4-a716-446655440002"</span>,
    <span class="hljs-attr">"status"</span>: <span class="hljs-string">"pending"</span>,
    <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Error report submitted successfully"</span>
  },
  <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2025-08-07T10:30:00Z"</span>,
  <span class="hljs-attr">"request_id"</span>: <span class="hljs-string">"req_123456789"</span>
}
</div></code></pre>
<h4 id="422-get-error-report">4.2.2 Get Error Report</h4>
<pre class="hljs"><code><div><span class="hljs-attribute">GET /api/v1/errors/{error_id}
Authorization</span>: Bearer {jwt_token}
</div></code></pre>
<h4 id="423-update-error-report">4.2.3 Update Error Report</h4>
<pre class="hljs"><code><div><span class="hljs-attribute">PUT /api/v1/errors/{error_id}
Content-Type</span>: application/json
<span class="hljs-attribute">Authorization</span>: Bearer {jwt_token}

<span class="json">{
  <span class="hljs-attr">"severity_level"</span>: <span class="hljs-string">"critical"</span>,
  <span class="hljs-attr">"context_notes"</span>: <span class="hljs-string">"Updated context information"</span>
}
</span></div></code></pre>
<h4 id="424-search-error-reports">4.2.4 Search Error Reports</h4>
<pre class="hljs"><code><div><span class="hljs-attribute">GET /api/v1/errors/search?speaker_id={speaker_id}&amp;category=medical_terminology&amp;severity=high&amp;page=1&amp;limit=20
Authorization</span>: Bearer {jwt_token}
</div></code></pre>
<h3 id="43-event-schema-definitions">4.3 Event Schema Definitions</h3>
<h4 id="431-error-reported-event">4.3.1 Error Reported Event</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Dict, Any

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorReportedEvent</span><span class="hljs-params">(BaseModel)</span>:</span>
    <span class="hljs-string">"""Event published when a new error is reported"""</span>
    event_id: str
    event_type: str = <span class="hljs-string">"error.reported"</span>
    version: str = <span class="hljs-string">"1.0"</span>
    timestamp: datetime
    source: str = <span class="hljs-string">"error-reporting-service"</span>
    correlation_id: str

    <span class="hljs-comment"># Event payload</span>
    error_id: str
    speaker_id: str
    job_id: str
    original_text: str
    corrected_text: str
    categories: List[str]
    severity: str
    reported_by: str
    metadata: Dict[str, Any]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorUpdatedEvent</span><span class="hljs-params">(BaseModel)</span>:</span>
    <span class="hljs-string">"""Event published when an error is updated"""</span>
    event_id: str
    event_type: str = <span class="hljs-string">"error.updated"</span>
    version: str = <span class="hljs-string">"1.0"</span>
    timestamp: datetime
    source: str = <span class="hljs-string">"error-reporting-service"</span>
    correlation_id: str

    <span class="hljs-comment"># Event payload</span>
    error_id: str
    updated_fields: Dict[str, Any]
    updated_by: str
    previous_values: Dict[str, Any]
</div></code></pre>
<hr>
<h2 id="5-data-architecture">5. Data Architecture</h2>
<h3 id="51-multi-database-schema-support">5.1 Multi-Database Schema Support</h3>
<p>The ERS system supports multiple database technologies through the adapter pattern. The same logical data model is implemented differently based on the database type while maintaining consistent business logic.</p>
<h4 id="511-logical-data-model">5.1.1 Logical Data Model</h4>
<p>The core entities remain consistent across all database implementations:</p>
<ul>
<li><strong>ErrorReport</strong>: Primary entity containing error information</li>
<li><strong>ErrorAuditLog</strong>: Audit trail for all error report changes</li>
<li><strong>ErrorCategory</strong>: Reference data for error categorization</li>
<li><strong>ErrorValidation</strong>: Validation results and metadata</li>
</ul>
<h4 id="512-postgresql-schema-relational-implementation">5.1.2 PostgreSQL Schema (Relational Implementation)</h4>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    ERROR_REPORTS {
        uuid error_id PK
        uuid job_id FK
        uuid speaker_id FK
        uuid reported_by FK
        text original_text
        text corrected_text
        json error_categories
        string severity_level
        integer start_position
        integer end_position
        text context_notes
        timestamp error_timestamp
        timestamp reported_at
        string status
        json metadata
        timestamp created_at
        timestamp updated_at
        uuid created_by
        uuid updated_by
    }

    ERROR_AUDIT_LOGS {
        uuid audit_id PK
        uuid error_id FK
        string action_type
        json old_values
        json new_values
        uuid performed_by FK
        timestamp performed_at
        string ip_address
        string user_agent
        string reason
    }

    ERROR_CATEGORIES {
        uuid category_id PK
        string category_name
        string description
        boolean is_active
        integer sort_order
        timestamp created_at
        timestamp updated_at
    }

    ERROR_VALIDATIONS {
        uuid validation_id PK
        uuid error_id FK
        string validation_type
        boolean is_valid
        json validation_details
        timestamp validated_at
        uuid validated_by FK
    }

    %% Relationships
    ERROR_REPORTS ||--o{ ERROR_AUDIT_LOGS : "has_audit_trail"
    ERROR_REPORTS ||--o{ ERROR_VALIDATIONS : "has_validations"
    ERROR_CATEGORIES ||--o{ ERROR_REPORTS : "categorizes"
</div></code></pre>
<h4 id="513-mongodb-schema-document-implementation">5.1.3 MongoDB Schema (Document Implementation)</h4>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"error_reports"</span>: {
    <span class="hljs-attr">"_id"</span>: <span class="hljs-string">"ObjectId | UUID string"</span>,
    <span class="hljs-attr">"job_id"</span>: <span class="hljs-string">"UUID string"</span>,
    <span class="hljs-attr">"speaker_id"</span>: <span class="hljs-string">"UUID string"</span>,
    <span class="hljs-attr">"reported_by"</span>: <span class="hljs-string">"UUID string"</span>,
    <span class="hljs-attr">"original_text"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"corrected_text"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"error_categories"</span>: [<span class="hljs-string">"string"</span>],
    <span class="hljs-attr">"severity_level"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"start_position"</span>: <span class="hljs-string">"number"</span>,
    <span class="hljs-attr">"end_position"</span>: <span class="hljs-string">"number"</span>,
    <span class="hljs-attr">"context_notes"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"error_timestamp"</span>: <span class="hljs-string">"ISODate"</span>,
    <span class="hljs-attr">"reported_at"</span>: <span class="hljs-string">"ISODate"</span>,
    <span class="hljs-attr">"status"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"metadata"</span>: {
      <span class="hljs-attr">"audio_quality"</span>: <span class="hljs-string">"string"</span>,
      <span class="hljs-attr">"background_noise"</span>: <span class="hljs-string">"string"</span>,
      <span class="hljs-attr">"confidence_score"</span>: <span class="hljs-string">"number"</span>,
      <span class="hljs-attr">"custom_fields"</span>: {}
    },
    <span class="hljs-attr">"audit_trail"</span>: [
      {
        <span class="hljs-attr">"action_type"</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">"old_values"</span>: {},
        <span class="hljs-attr">"new_values"</span>: {},
        <span class="hljs-attr">"performed_by"</span>: <span class="hljs-string">"UUID string"</span>,
        <span class="hljs-attr">"performed_at"</span>: <span class="hljs-string">"ISODate"</span>,
        <span class="hljs-attr">"ip_address"</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">"user_agent"</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">"reason"</span>: <span class="hljs-string">"string"</span>
      }
    ],
    <span class="hljs-attr">"validations"</span>: [
      {
        <span class="hljs-attr">"validation_type"</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">"is_valid"</span>: <span class="hljs-string">"boolean"</span>,
        <span class="hljs-attr">"validation_details"</span>: {},
        <span class="hljs-attr">"validated_at"</span>: <span class="hljs-string">"ISODate"</span>,
        <span class="hljs-attr">"validated_by"</span>: <span class="hljs-string">"UUID string"</span>
      }
    ],
    <span class="hljs-attr">"created_at"</span>: <span class="hljs-string">"ISODate"</span>,
    <span class="hljs-attr">"updated_at"</span>: <span class="hljs-string">"ISODate"</span>
  }
}
</div></code></pre>
<p><strong>MongoDB Indexes:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Compound indexes for efficient querying</span>
db.error_reports.createIndex({ <span class="hljs-string">"speaker_id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"reported_at"</span>: <span class="hljs-number">-1</span> })
db.error_reports.createIndex({ <span class="hljs-string">"job_id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"status"</span>: <span class="hljs-number">1</span> })
db.error_reports.createIndex({ <span class="hljs-string">"error_categories"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"severity_level"</span>: <span class="hljs-number">1</span> })
db.error_reports.createIndex({ <span class="hljs-string">"reported_by"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"reported_at"</span>: <span class="hljs-number">-1</span> })

<span class="hljs-comment">// Text index for full-text search</span>
db.error_reports.createIndex({
  <span class="hljs-string">"original_text"</span>: <span class="hljs-string">"text"</span>,
  <span class="hljs-string">"corrected_text"</span>: <span class="hljs-string">"text"</span>,
  <span class="hljs-string">"context_notes"</span>: <span class="hljs-string">"text"</span>
})

<span class="hljs-comment">// TTL index for automatic cleanup (optional)</span>
db.error_reports.createIndex({ <span class="hljs-string">"created_at"</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">expireAfterSeconds</span>: <span class="hljs-number">31536000</span> }) <span class="hljs-comment">// 1 year</span>
</div></code></pre>
<h4 id="514-sql-server-schema-adaptations">5.1.4 SQL Server Schema Adaptations</h4>
<p>For SQL Server, the schema includes specific optimizations:</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- SQL Server specific features</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> error_reports (
    error_id UNIQUEIDENTIFIER PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> NEWID(),
    job_id UNIQUEIDENTIFIER <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    speaker_id UNIQUEIDENTIFIER <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    reported_by UNIQUEIDENTIFIER <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    original_text <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    corrected_text <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    error_categories <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) <span class="hljs-keyword">CHECK</span> (ISJSON(error_categories) = <span class="hljs-number">1</span>),
    severity_level <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    start_position <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    end_position <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    context_notes <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>),
    error_timestamp DATETIME2 <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    reported_at DATETIME2 <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">GETUTCDATE</span>(),
    <span class="hljs-keyword">status</span> <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    metadata <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) <span class="hljs-keyword">CHECK</span> (ISJSON(metadata) = <span class="hljs-number">1</span>),
    created_at DATETIME2 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">GETUTCDATE</span>(),
    updated_at DATETIME2 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">GETUTCDATE</span>()
);

<span class="hljs-comment">-- Columnstore index for analytics</span>
<span class="hljs-keyword">CREATE</span> NONCLUSTERED COLUMNSTORE <span class="hljs-keyword">INDEX</span> IX_error_reports_analytics
<span class="hljs-keyword">ON</span> error_reports (speaker_id, severity_level, reported_at, error_categories);

<span class="hljs-comment">-- Full-text search capability</span>
<span class="hljs-keyword">CREATE</span> FULLTEXT <span class="hljs-keyword">CATALOG</span> error_reports_catalog;
<span class="hljs-keyword">CREATE</span> FULLTEXT <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> error_reports (original_text, corrected_text, context_notes)
<span class="hljs-keyword">KEY</span> <span class="hljs-keyword">INDEX</span> PK_error_reports <span class="hljs-keyword">ON</span> error_reports_catalog;
</div></code></pre>
<pre class="hljs"><code><div>
### 5.2 Database Adapter Implementation

#### 5.2.1 SQLAlchemy Models
```python
from sqlalchemy import Column, String, Text, Integer, DateTime, Boolean, JSON, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
import uuid
from datetime import datetime

Base = declarative_base()

class ErrorReportModel(Base):
    &quot;&quot;&quot;SQLAlchemy model for error reports&quot;&quot;&quot;
    __tablename__ = &quot;error_reports&quot;

    error_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    job_id = Column(UUID(as_uuid=True), nullable=False, index=True)
    speaker_id = Column(UUID(as_uuid=True), nullable=False, index=True)
    reported_by = Column(UUID(as_uuid=True), nullable=False, index=True)
    original_text = Column(Text, nullable=False)
    corrected_text = Column(Text, nullable=False)
    error_categories = Column(JSON, nullable=False)
    severity_level = Column(String(20), nullable=False, index=True)
    start_position = Column(Integer, nullable=False)
    end_position = Column(Integer, nullable=False)
    context_notes = Column(Text)
    error_timestamp = Column(DateTime, nullable=False)
    reported_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    status = Column(String(20), nullable=False, default=&quot;pending&quot;, index=True)
    metadata = Column(JSON, default={})
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    created_by = Column(UUID(as_uuid=True))
    updated_by = Column(UUID(as_uuid=True))

    # Relationships
    audit_logs = relationship(&quot;ErrorAuditLogModel&quot;, back_populates=&quot;error_report&quot;)
    validations = relationship(&quot;ErrorValidationModel&quot;, back_populates=&quot;error_report&quot;)

class ErrorAuditLogModel(Base):
    &quot;&quot;&quot;SQLAlchemy model for error audit logs&quot;&quot;&quot;
    __tablename__ = &quot;error_audit_logs&quot;

    audit_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    error_id = Column(UUID(as_uuid=True), ForeignKey(&quot;error_reports.error_id&quot;), nullable=False)
    action_type = Column(String(50), nullable=False, index=True)
    old_values = Column(JSON)
    new_values = Column(JSON)
    performed_by = Column(UUID(as_uuid=True), nullable=False)
    performed_at = Column(DateTime, default=datetime.utcnow)
    ip_address = Column(String(45))
    user_agent = Column(Text)
    reason = Column(Text)

    # Relationships
    error_report = relationship(&quot;ErrorReportModel&quot;, back_populates=&quot;audit_logs&quot;)
</div></code></pre>
<h4 id="522-repository-implementation">5.2.2 Repository Implementation</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Optional
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, update, delete
<span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> selectinload

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SQLAlchemyErrorReportRepository</span>:</span>
    <span class="hljs-string">"""SQLAlchemy implementation of ErrorReportRepository"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, session: AsyncSession)</span>:</span>
        self._session = session

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Save error report to database"""</span>
        model = ErrorReportModel(
            error_id=error_report.error_id,
            job_id=error_report.job_id,
            speaker_id=error_report.speaker_id,
            reported_by=error_report.reported_by,
            original_text=error_report.original_text,
            corrected_text=error_report.corrected_text,
            error_categories=error_report.error_categories,
            severity_level=error_report.severity_level.value,
            start_position=error_report.start_position,
            end_position=error_report.end_position,
            context_notes=error_report.context_notes,
            error_timestamp=error_report.error_timestamp,
            reported_at=error_report.reported_at,
            status=error_report.status.value,
            metadata=error_report.metadata
        )

        self._session.add(model)
        <span class="hljs-keyword">await</span> self._session.commit()
        <span class="hljs-keyword">await</span> self._session.refresh(model)

        <span class="hljs-keyword">return</span> self._model_to_entity(model)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        <span class="hljs-string">"""Find error report by ID"""</span>
        stmt = select(ErrorReportModel).where(ErrorReportModel.error_id == error_id)
        result = <span class="hljs-keyword">await</span> self._session.execute(stmt)
        model = result.scalar_one_or_none()

        <span class="hljs-keyword">return</span> self._model_to_entity(model) <span class="hljs-keyword">if</span> model <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_speaker</span><span class="hljs-params">(self, speaker_id: UUID)</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-string">"""Find all error reports for a speaker"""</span>
        stmt = select(ErrorReportModel).where(ErrorReportModel.speaker_id == speaker_id)
        result = <span class="hljs-keyword">await</span> self._session.execute(stmt)
        models = result.scalars().all()

        <span class="hljs-keyword">return</span> [self._model_to_entity(model) <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> models]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_model_to_entity</span><span class="hljs-params">(self, model: ErrorReportModel)</span> -&gt; ErrorReport:</span>
        <span class="hljs-string">"""Convert SQLAlchemy model to domain entity"""</span>
        <span class="hljs-keyword">return</span> ErrorReport(
            error_id=model.error_id,
            job_id=model.job_id,
            speaker_id=model.speaker_id,
            reported_by=model.reported_by,
            original_text=model.original_text,
            corrected_text=model.corrected_text,
            error_categories=model.error_categories,
            severity_level=SeverityLevel(model.severity_level),
            start_position=model.start_position,
            end_position=model.end_position,
            context_notes=model.context_notes,
            error_timestamp=model.error_timestamp,
            reported_at=model.reported_at,
            status=ErrorStatus(model.status),
            metadata=model.metadata
        )
</div></code></pre>
<hr>
<h2 id="6-implementation-guidelines">6. Implementation Guidelines</h2>
<h3 id="61-project-structure-multi-adapter-hexagonal-architecture">6.1 Project Structure (Multi-Adapter Hexagonal Architecture)</h3>
<pre class="hljs"><code><div>src/error_reporting_service/
├── domain/                     # Business Logic Core (No external dependencies)
│   ├── entities/
│   │   ├── __init__.py
│   │   ├── error_report.py     # ErrorReport entity
│   │   └── value_objects.py    # SeverityLevel, ErrorStatus enums
│   ├── services/
│   │   ├── __init__.py
│   │   ├── validation_service.py
│   │   └── categorization_service.py
│   └── events/
│       ├── __init__.py
│       └── domain_events.py    # ErrorReportedEvent, etc.
├── application/                # Use Cases and Application Services
│   ├── use_cases/
│   │   ├── __init__.py
│   │   ├── submit_error_report.py
│   │   ├── get_error_report.py
│   │   └── update_error_report.py
│   ├── dto/
│   │   ├── __init__.py
│   │   ├── requests.py         # Pydantic request models
│   │   └── responses.py        # Pydantic response models
│   └── ports/
│       ├── __init__.py
│       ├── primary/            # Driving ports
│       │   └── error_reporting_port.py
│       └── secondary/          # Driven ports
│           ├── database_port.py        # IDatabaseAdapter interface
│           ├── event_bus_port.py       # IEventBusAdapter interface
│           └── validation_port.py
├── infrastructure/             # Adapters and External Concerns
│   ├── adapters/
│   │   ├── database/           # Database Adapter Implementations
│   │   │   ├── __init__.py
│   │   │   ├── abstract/       # Abstract interfaces
│   │   │   │   ├── __init__.py
│   │   │   │   └── database_adapter.py  # IDatabaseAdapter
│   │   │   ├── postgresql/     # PostgreSQL implementation
│   │   │   │   ├── __init__.py
│   │   │   │   ├── adapter.py
│   │   │   │   ├── models.py
│   │   │   │   └── migrations/
│   │   │   ├── mongodb/        # MongoDB implementation
│   │   │   │   ├── __init__.py
│   │   │   │   ├── adapter.py
│   │   │   │   └── indexes.py
│   │   │   ├── sqlserver/      # SQL Server implementation
│   │   │   │   ├── __init__.py
│   │   │   │   ├── adapter.py
│   │   │   │   └── models.py
│   │   │   └── factory.py      # Database adapter factory
│   │   ├── messaging/          # Event Bus Adapter Implementations
│   │   │   ├── __init__.py
│   │   │   ├── abstract/       # Abstract interfaces
│   │   │   │   ├── __init__.py
│   │   │   │   └── event_bus_adapter.py  # IEventBusAdapter
│   │   │   ├── kafka/          # Kafka implementation
│   │   │   │   ├── __init__.py
│   │   │   │   ├── adapter.py
│   │   │   │   └── config.py
│   │   │   ├── azure_servicebus/  # Azure Service Bus implementation
│   │   │   │   ├── __init__.py
│   │   │   │   └── adapter.py
│   │   │   ├── aws_sqs/        # AWS SQS implementation
│   │   │   │   ├── __init__.py
│   │   │   │   └── adapter.py
│   │   │   ├── rabbitmq/       # RabbitMQ implementation
│   │   │   │   ├── __init__.py
│   │   │   │   └── adapter.py
│   │   │   └── factory.py      # Event bus adapter factory
│   │   ├── http/
│   │   │   ├── __init__.py
│   │   │   ├── controllers.py  # FastAPI controllers
│   │   │   ├── middleware.py   # Custom middleware
│   │   │   └── dependencies.py # Dependency injection
│   │   └── external/
│   │       ├── __init__.py
│   │       ├── user_service_client.py
│   │       └── validation_client.py
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings.py         # Pydantic Settings with adapter config
│   │   ├── database_config.py  # Database adapter configuration
│   │   └── messaging_config.py # Event bus adapter configuration
│   └── monitoring/
│       ├── __init__.py
│       ├── metrics.py          # Prometheus metrics
│       └── tracing.py          # OpenTelemetry tracing
├── tests/
│   ├── unit/                   # Unit tests (domain + application)
│   │   ├── domain/
│   │   ├── application/
│   │   └── adapters/           # Adapter-specific unit tests
│   ├── integration/            # Integration tests
│   │   ├── database/           # Database adapter integration tests
│   │   └── messaging/          # Event bus adapter integration tests
│   └── e2e/                    # End-to-end tests
├── main.py                     # FastAPI app setup with adapter factories
├── requirements.txt            # Python dependencies
├── pyproject.toml             # Poetry configuration
└── Dockerfile                 # Container configuration
</div></code></pre>
<h3 id="62-configuration-management-for-multi-adapter-support">6.2 Configuration Management for Multi-Adapter Support</h3>
<h4 id="621-settings-configuration">6.2.1 Settings Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseSettings, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, Dict, Any
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseType</span><span class="hljs-params">(str, Enum)</span>:</span>
    POSTGRESQL = <span class="hljs-string">"postgresql"</span>
    SQLSERVER = <span class="hljs-string">"sqlserver"</span>
    MONGODB = <span class="hljs-string">"mongodb"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusType</span><span class="hljs-params">(str, Enum)</span>:</span>
    KAFKA = <span class="hljs-string">"kafka"</span>
    AZURE_SERVICEBUS = <span class="hljs-string">"azure_servicebus"</span>
    AWS_SQS = <span class="hljs-string">"aws_sqs"</span>
    RABBITMQ = <span class="hljs-string">"rabbitmq"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConfig</span><span class="hljs-params">(BaseSettings)</span>:</span>
    <span class="hljs-string">"""Database configuration settings"""</span>
    type: DatabaseType = DatabaseType.POSTGRESQL
    host: str = <span class="hljs-string">"localhost"</span>
    port: int = <span class="hljs-number">5432</span>
    database: str = <span class="hljs-string">"error_reporting"</span>
    username: str = <span class="hljs-string">"ers_user"</span>
    password: str = <span class="hljs-string">"ers_password"</span>
    connection_string: Optional[str] = <span class="hljs-literal">None</span>
    pool_size: int = <span class="hljs-number">10</span>
    max_overflow: int = <span class="hljs-number">20</span>
    pool_timeout: int = <span class="hljs-number">30</span>

    <span class="hljs-comment"># MongoDB specific</span>
    replica_set: Optional[str] = <span class="hljs-literal">None</span>
    auth_source: Optional[str] = <span class="hljs-literal">None</span>

    <span class="hljs-comment"># SQL Server specific</span>
    driver: str = <span class="hljs-string">"ODBC Driver 17 for SQL Server"</span>
    trust_server_certificate: bool = <span class="hljs-literal">True</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span>
        env_prefix = <span class="hljs-string">"DB_"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusConfig</span><span class="hljs-params">(BaseSettings)</span>:</span>
    <span class="hljs-string">"""Event bus configuration settings"""</span>
    type: EventBusType = EventBusType.KAFKA
    connection_string: str = <span class="hljs-string">"localhost:9092"</span>
    client_id: str = <span class="hljs-string">"error-reporting-service"</span>

    <span class="hljs-comment"># Kafka specific</span>
    bootstrap_servers: Optional[str] = <span class="hljs-literal">None</span>
    security_protocol: str = <span class="hljs-string">"PLAINTEXT"</span>
    sasl_mechanism: Optional[str] = <span class="hljs-literal">None</span>
    sasl_username: Optional[str] = <span class="hljs-literal">None</span>
    sasl_password: Optional[str] = <span class="hljs-literal">None</span>

    <span class="hljs-comment"># Azure Service Bus specific</span>
    namespace: Optional[str] = <span class="hljs-literal">None</span>
    shared_access_key_name: Optional[str] = <span class="hljs-literal">None</span>
    shared_access_key: Optional[str] = <span class="hljs-literal">None</span>

    <span class="hljs-comment"># AWS SQS specific</span>
    region_name: Optional[str] = <span class="hljs-literal">None</span>
    access_key_id: Optional[str] = <span class="hljs-literal">None</span>
    secret_access_key: Optional[str] = <span class="hljs-literal">None</span>

    <span class="hljs-comment"># RabbitMQ specific</span>
    virtual_host: str = <span class="hljs-string">"/"</span>
    heartbeat: int = <span class="hljs-number">600</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span>
        env_prefix = <span class="hljs-string">"EVENT_BUS_"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Settings</span><span class="hljs-params">(BaseSettings)</span>:</span>
    <span class="hljs-string">"""Main application settings"""</span>
    app_name: str = <span class="hljs-string">"Error Reporting Service"</span>
    debug: bool = <span class="hljs-literal">False</span>
    log_level: str = <span class="hljs-string">"INFO"</span>

    <span class="hljs-comment"># Adapter configurations</span>
    database: DatabaseConfig = DatabaseConfig()
    event_bus: EventBusConfig = EventBusConfig()

    <span class="hljs-comment"># API settings</span>
    api_prefix: str = <span class="hljs-string">"/api/v1"</span>
    cors_origins: list = [<span class="hljs-string">"*"</span>]

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span>
        env_file = <span class="hljs-string">".env"</span>
        case_sensitive = <span class="hljs-literal">False</span>

<span class="hljs-comment"># Global settings instance</span>
settings = Settings()
</div></code></pre>
<h4 id="622-adapter-factory-pattern">6.2.2 Adapter Factory Pattern</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Protocol
<span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdapterFactory</span><span class="hljs-params">(ABC)</span>:</span>
    <span class="hljs-string">"""Abstract factory for creating adapters"""</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_database_adapter</span><span class="hljs-params">(self, config: DatabaseConfig)</span> -&gt; IDatabaseAdapter:</span>
        <span class="hljs-string">"""Create database adapter based on configuration"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_event_bus_adapter</span><span class="hljs-params">(self, config: EventBusConfig)</span> -&gt; IEventBusAdapter:</span>
        <span class="hljs-string">"""Create event bus adapter based on configuration"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseAdapterFactory</span>:</span>
    <span class="hljs-string">"""Factory for creating database adapters"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span><span class="hljs-params">(config: DatabaseConfig)</span> -&gt; IDatabaseAdapter:</span>
        <span class="hljs-string">"""Create database adapter based on configuration"""</span>
        <span class="hljs-keyword">if</span> config.type == DatabaseType.POSTGRESQL:
            <span class="hljs-keyword">from</span> infrastructure.adapters.database.postgresql.adapter <span class="hljs-keyword">import</span> PostgreSQLAdapter
            connection_string = config.connection_string <span class="hljs-keyword">or</span> <span class="hljs-string">f"postgresql+asyncpg://<span class="hljs-subst">{config.username}</span>:<span class="hljs-subst">{config.password}</span>@<span class="hljs-subst">{config.host}</span>:<span class="hljs-subst">{config.port}</span>/<span class="hljs-subst">{config.database}</span>"</span>
            <span class="hljs-keyword">return</span> PostgreSQLAdapter(connection_string)

        <span class="hljs-keyword">elif</span> config.type == DatabaseType.MONGODB:
            <span class="hljs-keyword">from</span> infrastructure.adapters.database.mongodb.adapter <span class="hljs-keyword">import</span> MongoDBAdapter
            connection_string = config.connection_string <span class="hljs-keyword">or</span> <span class="hljs-string">f"mongodb://<span class="hljs-subst">{config.username}</span>:<span class="hljs-subst">{config.password}</span>@<span class="hljs-subst">{config.host}</span>:<span class="hljs-subst">{config.port}</span>"</span>
            <span class="hljs-keyword">return</span> MongoDBAdapter(connection_string, config.database)

        <span class="hljs-keyword">elif</span> config.type == DatabaseType.SQLSERVER:
            <span class="hljs-keyword">from</span> infrastructure.adapters.database.sqlserver.adapter <span class="hljs-keyword">import</span> SQLServerAdapter
            connection_string = config.connection_string <span class="hljs-keyword">or</span> <span class="hljs-string">f"mssql+aioodbc://<span class="hljs-subst">{config.username}</span>:<span class="hljs-subst">{config.password}</span>@<span class="hljs-subst">{config.host}</span>:<span class="hljs-subst">{config.port}</span>/<span class="hljs-subst">{config.database}</span>?driver=<span class="hljs-subst">{config.driver}</span>&amp;TrustServerCertificate=<span class="hljs-subst">{config.trust_server_certificate}</span>"</span>
            <span class="hljs-keyword">return</span> SQLServerAdapter(connection_string)

        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Unsupported database type: <span class="hljs-subst">{config.type}</span>"</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusAdapterFactory</span>:</span>
    <span class="hljs-string">"""Factory for creating event bus adapters"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span><span class="hljs-params">(config: EventBusConfig)</span> -&gt; IEventBusAdapter:</span>
        <span class="hljs-string">"""Create event bus adapter based on configuration"""</span>
        <span class="hljs-keyword">if</span> config.type == EventBusType.KAFKA:
            <span class="hljs-keyword">from</span> infrastructure.adapters.messaging.kafka.adapter <span class="hljs-keyword">import</span> KafkaAdapter
            bootstrap_servers = config.bootstrap_servers <span class="hljs-keyword">or</span> config.connection_string
            <span class="hljs-keyword">return</span> KafkaAdapter(bootstrap_servers, config.client_id)

        <span class="hljs-keyword">elif</span> config.type == EventBusType.AZURE_SERVICEBUS:
            <span class="hljs-keyword">from</span> infrastructure.adapters.messaging.azure_servicebus.adapter <span class="hljs-keyword">import</span> AzureServiceBusAdapter
            <span class="hljs-keyword">return</span> AzureServiceBusAdapter(config.connection_string)

        <span class="hljs-keyword">elif</span> config.type == EventBusType.AWS_SQS:
            <span class="hljs-keyword">from</span> infrastructure.adapters.messaging.aws_sqs.adapter <span class="hljs-keyword">import</span> AWSSQSAdapter
            <span class="hljs-keyword">return</span> AWSSQSAdapter(
                region_name=config.region_name,
                access_key_id=config.access_key_id,
                secret_access_key=config.secret_access_key
            )

        <span class="hljs-keyword">elif</span> config.type == EventBusType.RABBITMQ:
            <span class="hljs-keyword">from</span> infrastructure.adapters.messaging.rabbitmq.adapter <span class="hljs-keyword">import</span> RabbitMQAdapter
            <span class="hljs-keyword">return</span> RabbitMQAdapter(config.connection_string, config.virtual_host)

        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Unsupported event bus type: <span class="hljs-subst">{config.type}</span>"</span>)
</div></code></pre>
<h3 id="63-multi-adapter-dependency-injection-setup">6.3 Multi-Adapter Dependency Injection Setup</h3>
<h4 id="631-adapter-agnostic-fastapi-dependencies">6.3.1 Adapter-Agnostic FastAPI Dependencies</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Annotated
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-comment"># Singleton adapter instances</span>
_database_adapter: Optional[IDatabaseAdapter] = <span class="hljs-literal">None</span>
_event_bus_adapter: Optional[IEventBusAdapter] = <span class="hljs-literal">None</span>

<span class="hljs-meta">@lru_cache()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_settings</span><span class="hljs-params">()</span> -&gt; Settings:</span>
    <span class="hljs-string">"""Get application settings (cached)"""</span>
    <span class="hljs-keyword">return</span> Settings()

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_database_adapter</span><span class="hljs-params">()</span> -&gt; IDatabaseAdapter:</span>
    <span class="hljs-string">"""Get database adapter instance (singleton)"""</span>
    <span class="hljs-keyword">global</span> _database_adapter
    <span class="hljs-keyword">if</span> _database_adapter <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        settings = get_settings()
        _database_adapter = <span class="hljs-keyword">await</span> DatabaseAdapterFactory.create(settings.database)
    <span class="hljs-keyword">return</span> _database_adapter

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_event_bus_adapter</span><span class="hljs-params">()</span> -&gt; IEventBusAdapter:</span>
    <span class="hljs-string">"""Get event bus adapter instance (singleton)"""</span>
    <span class="hljs-keyword">global</span> _event_bus_adapter
    <span class="hljs-keyword">if</span> _event_bus_adapter <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        settings = get_settings()
        _event_bus_adapter = <span class="hljs-keyword">await</span> EventBusAdapterFactory.create(settings.event_bus)
    <span class="hljs-keyword">return</span> _event_bus_adapter

<span class="hljs-comment"># Repository dependencies (adapter-agnostic)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_error_repository</span><span class="hljs-params">(
    db_adapter: Annotated[IDatabaseAdapter, Depends<span class="hljs-params">(get_database_adapter)</span>]
)</span> -&gt; ErrorReportRepository:</span>
    <span class="hljs-string">"""Get error repository using configured database adapter"""</span>
    <span class="hljs-keyword">return</span> DatabaseAdapterRepository(db_adapter)

<span class="hljs-comment"># Event publisher dependencies (adapter-agnostic)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_event_publisher</span><span class="hljs-params">(
    event_adapter: Annotated[IEventBusAdapter, Depends<span class="hljs-params">(get_event_bus_adapter)</span>]
)</span> -&gt; EventPublisher:</span>
    <span class="hljs-string">"""Get event publisher using configured event bus adapter"""</span>
    <span class="hljs-keyword">return</span> EventBusAdapterPublisher(event_adapter)

<span class="hljs-comment"># Service dependencies (unchanged - pure domain logic)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_validation_service</span><span class="hljs-params">()</span> -&gt; ErrorValidationService:</span>
    <span class="hljs-keyword">return</span> ErrorValidationService()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_categorization_service</span><span class="hljs-params">()</span> -&gt; ErrorCategorizationService:</span>
    <span class="hljs-keyword">return</span> ErrorCategorizationService()

<span class="hljs-comment"># Use case dependencies (adapter-agnostic)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_submit_error_use_case</span><span class="hljs-params">(
    repository: Annotated[ErrorReportRepository, Depends<span class="hljs-params">(get_error_repository)</span>],
    event_publisher: Annotated[EventPublisher, Depends<span class="hljs-params">(get_event_publisher)</span>],
    validation_service: Annotated[ErrorValidationService, Depends<span class="hljs-params">(get_validation_service)</span>],
    categorization_service: Annotated[ErrorCategorizationService, Depends<span class="hljs-params">(get_categorization_service)</span>]
)</span> -&gt; SubmitErrorReportUseCase:</span>
    <span class="hljs-keyword">return</span> SubmitErrorReportUseCase(
        repository, event_publisher, validation_service, categorization_service
    )

<span class="hljs-comment">#### 6.3.2 Adapter Bridge Classes</span>
```python
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseAdapterRepository</span><span class="hljs-params">(ErrorReportRepository)</span>:</span>
    <span class="hljs-string">"""Bridge between repository interface and database adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, db_adapter: IDatabaseAdapter)</span>:</span>
        self._db_adapter = db_adapter

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save</span><span class="hljs-params">(self, error_report: ErrorReport)</span> -&gt; ErrorReport:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self._db_adapter.save_error_report(error_report)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_id</span><span class="hljs-params">(self, error_id: UUID)</span> -&gt; Optional[ErrorReport]:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self._db_adapter.find_error_by_id(error_id)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_speaker</span><span class="hljs-params">(self, speaker_id: UUID)</span> -&gt; List[ErrorReport]:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self._db_adapter.find_errors_by_speaker(speaker_id)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusAdapterPublisher</span><span class="hljs-params">(EventPublisher)</span>:</span>
    <span class="hljs-string">"""Bridge between event publisher interface and event bus adapter"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, event_adapter: IEventBusAdapter)</span>:</span>
        self._event_adapter = event_adapter

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_error_reported</span><span class="hljs-params">(self, event: ErrorReportedEvent)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-keyword">await</span> self._event_adapter.publish_event(<span class="hljs-string">"error.reported"</span>, event)

    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish_error_updated</span><span class="hljs-params">(self, event: ErrorUpdatedEvent)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-keyword">await</span> self._event_adapter.publish_event(<span class="hljs-string">"error.updated"</span>, event)

<span class="hljs-comment">#### 6.3.3 Environment-Based Configuration Examples</span>

**Development Environment (.env.dev):**
```bash
<span class="hljs-comment"># Database Configuration</span>
DB_TYPE=postgresql
DB_HOST=localhost
DB_PORT=<span class="hljs-number">5432</span>
DB_DATABASE=error_reporting_dev
DB_USERNAME=dev_user
DB_PASSWORD=dev_password

<span class="hljs-comment"># Event Bus Configuration</span>
EVENT_BUS_TYPE=kafka
EVENT_BUS_CONNECTION_STRING=localhost:<span class="hljs-number">9092</span>
EVENT_BUS_CLIENT_ID=ers-dev
</div></code></pre>
<p><strong>Production Environment (.env.prod):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Database Configuration</span>
DB_TYPE=postgresql
DB_CONNECTION_STRING=postgresql+asyncpg://prod_user:prod_password@prod-db-cluster:5432/error_reporting_prod
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=30

<span class="hljs-comment"># Event Bus Configuration</span>
EVENT_BUS_TYPE=azure_servicebus
EVENT_BUS_CONNECTION_STRING=Endpoint=sb://prod-servicebus.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=...
EVENT_BUS_CLIENT_ID=ers-prod
</div></code></pre>
<p><strong>Cloud Environment (.env.cloud):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Database Configuration</span>
DB_TYPE=mongodb
DB_CONNECTION_STRING=mongodb+srv://cloud_user:cloud_password@cluster.mongodb.net/error_reporting?retryWrites=<span class="hljs-literal">true</span>&amp;w=majority
DB_DATABASE=error_reporting

<span class="hljs-comment"># Event Bus Configuration</span>
EVENT_BUS_TYPE=aws_sqs
EVENT_BUS_REGION_NAME=us-east-1
EVENT_BUS_ACCESS_KEY_ID=AKIA...
EVENT_BUS_SECRET_ACCESS_KEY=...
</div></code></pre>
<h3 id="63-fastapi-controller-implementation">6.3 FastAPI Controller Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Depends, HTTPException, status
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Annotated

router = APIRouter(prefix=<span class="hljs-string">"/api/v1/errors"</span>, tags=[<span class="hljs-string">"error-reporting"</span>])

<span class="hljs-meta">@router.post("/report", status_code=status.HTTP_201_CREATED)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">submit_error_report</span><span class="hljs-params">(
    request: SubmitErrorReportRequest,
    use_case: Annotated[SubmitErrorReportUseCase, Depends<span class="hljs-params">(get_submit_error_use_case)</span>],
    current_user: Annotated[User, Depends<span class="hljs-params">(get_current_user)</span>]
)</span> -&gt; SubmitErrorReportResponse:</span>
    <span class="hljs-string">"""Submit a new error report"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Add user context to request</span>
        request.reported_by = str(current_user.user_id)

        response = <span class="hljs-keyword">await</span> use_case.execute(request)
        <span class="hljs-keyword">return</span> response

    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># Log error for monitoring</span>
        logger.error(<span class="hljs-string">f"Error submitting report: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">raise</span> HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=<span class="hljs-string">"Internal server error"</span>
        )

<span class="hljs-meta">@router.get("/{error_id}")</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_error_report</span><span class="hljs-params">(
    error_id: str,
    use_case: Annotated[GetErrorReportUseCase, Depends<span class="hljs-params">(get_get_error_use_case)</span>],
    current_user: Annotated[User, Depends<span class="hljs-params">(get_current_user)</span>]
)</span> -&gt; ErrorReport:</span>
    <span class="hljs-string">"""Get error report by ID"""</span>
    <span class="hljs-keyword">try</span>:
        error_report = <span class="hljs-keyword">await</span> use_case.execute(error_id)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> error_report:
            <span class="hljs-keyword">raise</span> HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=<span class="hljs-string">"Error report not found"</span>
            )
        <span class="hljs-keyword">return</span> error_report

    <span class="hljs-keyword">except</span> HTTPException:
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"Error retrieving report <span class="hljs-subst">{error_id}</span>: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">raise</span> HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=<span class="hljs-string">"Internal server error"</span>
        )
</div></code></pre>
<hr>
<h2 id="7-testing-strategy">7. Testing Strategy</h2>
<h3 id="71-multi-adapter-test-driven-development-tdd-approach">7.1 Multi-Adapter Test-Driven Development (TDD) Approach</h3>
<h4 id="711-unit-testing-70-coverage-target">7.1.1 Unit Testing (70% Coverage Target)</h4>
<p><strong>Framework</strong>: pytest with pytest-asyncio for async testing</p>
<p>The testing strategy ensures that all adapters can be tested in isolation while maintaining consistent behavior across different implementations.</p>
<p><strong>Domain Layer Tests</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> src.domain.entities.error_report <span class="hljs-keyword">import</span> ErrorReport, SeverityLevel, ErrorStatus
<span class="hljs-keyword">from</span> src.domain.services.validation_service <span class="hljs-keyword">import</span> ErrorValidationService

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestErrorReportEntity</span>:</span>
    <span class="hljs-string">"""Unit tests for ErrorReport domain entity"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_valid_error_report</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test creating a valid error report"""</span>
        error_report = ErrorReport(
            error_id=uuid4(),
            job_id=uuid4(),
            speaker_id=uuid4(),
            reported_by=uuid4(),
            original_text=<span class="hljs-string">"The patient has diabetis"</span>,
            corrected_text=<span class="hljs-string">"The patient has diabetes"</span>,
            error_categories=[<span class="hljs-string">"medical_terminology"</span>],
            severity_level=SeverityLevel.HIGH,
            start_position=<span class="hljs-number">16</span>,
            end_position=<span class="hljs-number">24</span>,
            error_timestamp=datetime.utcnow(),
            reported_at=datetime.utcnow()
        )

        <span class="hljs-keyword">assert</span> error_report.original_text == <span class="hljs-string">"The patient has diabetis"</span>
        <span class="hljs-keyword">assert</span> error_report.corrected_text == <span class="hljs-string">"The patient has diabetes"</span>
        <span class="hljs-keyword">assert</span> error_report.severity_level == SeverityLevel.HIGH

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_invalid_position_range_raises_error</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test that invalid position range raises validation error"""</span>
        <span class="hljs-keyword">with</span> pytest.raises(ValueError, match=<span class="hljs-string">"end_position must be greater than start_position"</span>):
            ErrorReport(
                error_id=uuid4(),
                job_id=uuid4(),
                speaker_id=uuid4(),
                reported_by=uuid4(),
                original_text=<span class="hljs-string">"Test text"</span>,
                corrected_text=<span class="hljs-string">"Corrected text"</span>,
                error_categories=[<span class="hljs-string">"grammar"</span>],
                severity_level=SeverityLevel.LOW,
                start_position=<span class="hljs-number">10</span>,
                end_position=<span class="hljs-number">5</span>,  <span class="hljs-comment"># Invalid: less than start_position</span>
                error_timestamp=datetime.utcnow(),
                reported_at=datetime.utcnow()
            )

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestErrorValidationService</span>:</span>
    <span class="hljs-string">"""Unit tests for ErrorValidationService"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_method</span><span class="hljs-params">(self)</span>:</span>
        self.validation_service = ErrorValidationService()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_validate_error_categories_valid</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test validation of valid error categories"""</span>
        valid_categories = [<span class="hljs-string">"pronunciation"</span>, <span class="hljs-string">"medical_terminology"</span>]
        result = self.validation_service.validate_error_categories(valid_categories)
        <span class="hljs-keyword">assert</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_validate_error_categories_invalid</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test validation of invalid error categories"""</span>
        invalid_categories = [<span class="hljs-string">"invalid_category"</span>, <span class="hljs-string">"medical_terminology"</span>]
        result = self.validation_service.validate_error_categories(invalid_categories)
        <span class="hljs-keyword">assert</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>
</div></code></pre>
<p><strong>Application Layer Tests</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> AsyncMock, Mock
<span class="hljs-keyword">from</span> src.application.use_cases.submit_error_report <span class="hljs-keyword">import</span> SubmitErrorReportUseCase
<span class="hljs-keyword">from</span> src.application.dto.requests <span class="hljs-keyword">import</span> SubmitErrorReportRequest

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSubmitErrorReportUseCase</span>:</span>
    <span class="hljs-string">"""Unit tests for SubmitErrorReportUseCase"""</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_method</span><span class="hljs-params">(self)</span>:</span>
        self.mock_repository = AsyncMock()
        self.mock_event_publisher = AsyncMock()
        self.mock_validation_service = Mock()
        self.mock_categorization_service = Mock()

        self.use_case = SubmitErrorReportUseCase(
            self.mock_repository,
            self.mock_event_publisher,
            self.mock_validation_service,
            self.mock_categorization_service
        )

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_execute_valid_request_success</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test successful execution with valid request"""</span>
        <span class="hljs-comment"># Arrange</span>
        request = SubmitErrorReportRequest(
            job_id=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>,
            speaker_id=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440001"</span>,
            original_text=<span class="hljs-string">"diabetis"</span>,
            corrected_text=<span class="hljs-string">"diabetes"</span>,
            error_categories=[<span class="hljs-string">"medical_terminology"</span>],
            severity_level=<span class="hljs-string">"high"</span>,
            start_position=<span class="hljs-number">0</span>,
            end_position=<span class="hljs-number">8</span>,
            context_notes=<span class="hljs-string">"Common misspelling"</span>,
            reported_by=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440002"</span>,
            metadata={}
        )

        self.mock_validation_service.validate_error_categories.return_value = <span class="hljs-literal">True</span>
        self.mock_validation_service.validate_context_integrity.return_value = <span class="hljs-literal">True</span>
        self.mock_repository.save.return_value = Mock(error_id=uuid4())

        <span class="hljs-comment"># Act</span>
        response = <span class="hljs-keyword">await</span> self.use_case.execute(request)

        <span class="hljs-comment"># Assert</span>
        <span class="hljs-keyword">assert</span> response.status == <span class="hljs-string">"success"</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"successfully"</span> <span class="hljs-keyword">in</span> response.message
        self.mock_repository.save.assert_called_once()
        self.mock_event_publisher.publish_error_reported.assert_called_once()

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_execute_invalid_categories_raises_error</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test that invalid categories raise ValueError"""</span>
        <span class="hljs-comment"># Arrange</span>
        request = SubmitErrorReportRequest(
            job_id=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>,
            speaker_id=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440001"</span>,
            original_text=<span class="hljs-string">"test"</span>,
            corrected_text=<span class="hljs-string">"corrected"</span>,
            error_categories=[<span class="hljs-string">"invalid_category"</span>],
            severity_level=<span class="hljs-string">"low"</span>,
            start_position=<span class="hljs-number">0</span>,
            end_position=<span class="hljs-number">4</span>,
            reported_by=<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440002"</span>,
            metadata={}
        )

        self.mock_validation_service.validate_error_categories.return_value = <span class="hljs-literal">False</span>

        <span class="hljs-comment"># Act &amp; Assert</span>
        <span class="hljs-keyword">with</span> pytest.raises(ValueError, match=<span class="hljs-string">"Invalid error categories"</span>):
            <span class="hljs-keyword">await</span> self.use_case.execute(request)

<span class="hljs-comment">#### 7.1.3 Adapter Testing Strategy</span>

**Abstract Adapter Interface Tests**:
```python
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Type
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseAdapterTestSuite</span>:</span>
    <span class="hljs-string">"""Abstract test suite for database adapters - ensures consistent behavior"""</span>

<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">adapter</span><span class="hljs-params">(self)</span> -&gt; IDatabaseAdapter:</span>
        <span class="hljs-string">"""Override in concrete test classes"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_save_and_retrieve_error_report</span><span class="hljs-params">(self, adapter: IDatabaseAdapter)</span>:</span>
        <span class="hljs-string">"""Test saving and retrieving error report - works for all adapters"""</span>
        <span class="hljs-comment"># Arrange</span>
        error_report = ErrorReport(
            error_id=uuid4(),
            job_id=uuid4(),
            speaker_id=uuid4(),
            reported_by=uuid4(),
            original_text=<span class="hljs-string">"test error"</span>,
            corrected_text=<span class="hljs-string">"test correction"</span>,
            error_categories=[<span class="hljs-string">"grammar"</span>],
            severity_level=SeverityLevel.LOW,
            start_position=<span class="hljs-number">0</span>,
            end_position=<span class="hljs-number">10</span>,
            error_timestamp=datetime.utcnow(),
            reported_at=datetime.utcnow()
        )

        <span class="hljs-comment"># Act</span>
        saved_report = <span class="hljs-keyword">await</span> adapter.save_error_report(error_report)
        retrieved_report = <span class="hljs-keyword">await</span> adapter.find_error_by_id(saved_report.error_id)

        <span class="hljs-comment"># Assert</span>
        <span class="hljs-keyword">assert</span> retrieved_report <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">assert</span> retrieved_report.error_id == error_report.error_id
        <span class="hljs-keyword">assert</span> retrieved_report.original_text == error_report.original_text
        <span class="hljs-keyword">assert</span> retrieved_report.corrected_text == error_report.corrected_text

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_find_errors_by_speaker</span><span class="hljs-params">(self, adapter: IDatabaseAdapter)</span>:</span>
        <span class="hljs-string">"""Test finding errors by speaker - works for all adapters"""</span>
        <span class="hljs-comment"># Arrange</span>
        speaker_id = uuid4()
        error_report1 = self._create_test_error_report(speaker_id=speaker_id)
        error_report2 = self._create_test_error_report(speaker_id=speaker_id)
        other_speaker_report = self._create_test_error_report(speaker_id=uuid4())

        <span class="hljs-comment"># Act</span>
        <span class="hljs-keyword">await</span> adapter.save_error_report(error_report1)
        <span class="hljs-keyword">await</span> adapter.save_error_report(error_report2)
        <span class="hljs-keyword">await</span> adapter.save_error_report(other_speaker_report)

        speaker_errors = <span class="hljs-keyword">await</span> adapter.find_errors_by_speaker(speaker_id)

        <span class="hljs-comment"># Assert</span>
        <span class="hljs-keyword">assert</span> len(speaker_errors) == <span class="hljs-number">2</span>
        <span class="hljs-keyword">assert</span> all(error.speaker_id == speaker_id <span class="hljs-keyword">for</span> error <span class="hljs-keyword">in</span> speaker_errors)

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_transaction_rollback</span><span class="hljs-params">(self, adapter: IDatabaseAdapter)</span>:</span>
        <span class="hljs-string">"""Test transaction rollback - works for all adapters"""</span>
        <span class="hljs-comment"># Arrange</span>
        error_report = self._create_test_error_report()

        <span class="hljs-comment"># Act &amp; Assert</span>
        transaction = <span class="hljs-keyword">await</span> adapter.begin_transaction()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">await</span> adapter.save_error_report(error_report)
            <span class="hljs-comment"># Simulate error and rollback</span>
            <span class="hljs-keyword">await</span> adapter.rollback_transaction(transaction)

            <span class="hljs-comment"># Verify rollback worked</span>
            retrieved = <span class="hljs-keyword">await</span> adapter.find_error_by_id(error_report.error_id)
            <span class="hljs-keyword">assert</span> retrieved <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">await</span> adapter.rollback_transaction(transaction)
            <span class="hljs-keyword">raise</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgreSQLAdapterTest</span><span class="hljs-params">(DatabaseAdapterTestSuite)</span>:</span>
    <span class="hljs-string">"""PostgreSQL adapter specific tests"""</span>

<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">adapter</span><span class="hljs-params">(self)</span> -&gt; PostgreSQLAdapter:</span>
        <span class="hljs-string">"""Create PostgreSQL adapter for testing"""</span>
        <span class="hljs-comment"># Use test database</span>
        connection_string = <span class="hljs-string">"postgresql+asyncpg://test:test@localhost:5432/test_db"</span>
        adapter = PostgreSQLAdapter(connection_string)

        <span class="hljs-comment"># Setup test schema</span>
        <span class="hljs-keyword">await</span> self._setup_test_schema(adapter)
        <span class="hljs-keyword">yield</span> adapter
        <span class="hljs-keyword">await</span> self._cleanup_test_schema(adapter)

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_postgresql_specific_features</span><span class="hljs-params">(self, adapter: PostgreSQLAdapter)</span>:</span>
        <span class="hljs-string">"""Test PostgreSQL-specific functionality"""</span>
        <span class="hljs-comment"># Test JSONB queries, full-text search, etc.</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoDBAdapterTest</span><span class="hljs-params">(DatabaseAdapterTestSuite)</span>:</span>
    <span class="hljs-string">"""MongoDB adapter specific tests"""</span>

<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">adapter</span><span class="hljs-params">(self)</span> -&gt; MongoDBAdapter:</span>
        <span class="hljs-string">"""Create MongoDB adapter for testing"""</span>
        connection_string = <span class="hljs-string">"mongodb://test:test@localhost:27017"</span>
        adapter = MongoDBAdapter(connection_string, <span class="hljs-string">"test_db"</span>)

        <span class="hljs-comment"># Setup test collections</span>
        <span class="hljs-keyword">await</span> self._setup_test_collections(adapter)
        <span class="hljs-keyword">yield</span> adapter
        <span class="hljs-keyword">await</span> self._cleanup_test_collections(adapter)

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_mongodb_specific_features</span><span class="hljs-params">(self, adapter: MongoDBAdapter)</span>:</span>
        <span class="hljs-string">"""Test MongoDB-specific functionality"""</span>
        <span class="hljs-comment"># Test aggregation pipelines, text search, etc.</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusAdapterTestSuite</span>:</span>
    <span class="hljs-string">"""Abstract test suite for event bus adapters"""</span>

<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">adapter</span><span class="hljs-params">(self)</span> -&gt; IEventBusAdapter:</span>
        <span class="hljs-string">"""Override in concrete test classes"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_publish_and_consume_event</span><span class="hljs-params">(self, adapter: IEventBusAdapter)</span>:</span>
        <span class="hljs-string">"""Test publishing and consuming events - works for all adapters"""</span>
        <span class="hljs-comment"># Arrange</span>
        topic = <span class="hljs-string">"test.topic"</span>
        event = ErrorReportedEvent(
            event_id=str(uuid4()),
            error_id=str(uuid4()),
            speaker_id=str(uuid4()),
            job_id=str(uuid4()),
            original_text=<span class="hljs-string">"test"</span>,
            corrected_text=<span class="hljs-string">"corrected"</span>,
            categories=[<span class="hljs-string">"grammar"</span>],
            severity=<span class="hljs-string">"low"</span>,
            reported_by=str(uuid4()),
            timestamp=datetime.utcnow(),
            metadata={}
        )

        received_events = []

        <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">event_handler</span><span class="hljs-params">(event_data)</span>:</span>
            received_events.append(event_data)

        <span class="hljs-comment"># Act</span>
        <span class="hljs-keyword">await</span> adapter.create_topic(topic)
        <span class="hljs-keyword">await</span> adapter.subscribe_to_topic(topic, event_handler)
        success = <span class="hljs-keyword">await</span> adapter.publish_event(topic, event)

        <span class="hljs-comment"># Wait for message processing</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)

        <span class="hljs-comment"># Assert</span>
        <span class="hljs-keyword">assert</span> success <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">assert</span> len(received_events) == <span class="hljs-number">1</span>
        <span class="hljs-keyword">assert</span> received_events[<span class="hljs-number">0</span>][<span class="hljs-string">"event_id"</span>] == event.event_id

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_health_check</span><span class="hljs-params">(self, adapter: IEventBusAdapter)</span>:</span>
        <span class="hljs-string">"""Test health check - works for all adapters"""</span>
        health_status = <span class="hljs-keyword">await</span> adapter.health_check()
        <span class="hljs-keyword">assert</span> isinstance(health_status, bool)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaAdapterTest</span><span class="hljs-params">(EventBusAdapterTestSuite)</span>:</span>
    <span class="hljs-string">"""Kafka adapter specific tests"""</span>

<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">adapter</span><span class="hljs-params">(self)</span> -&gt; KafkaAdapter:</span>
        <span class="hljs-string">"""Create Kafka adapter for testing"""</span>
        adapter = KafkaAdapter(<span class="hljs-string">"localhost:9092"</span>, <span class="hljs-string">"test-client"</span>)
        <span class="hljs-keyword">yield</span> adapter
        <span class="hljs-comment"># Cleanup if needed</span>

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_kafka_specific_features</span><span class="hljs-params">(self, adapter: KafkaAdapter)</span>:</span>
        <span class="hljs-string">"""Test Kafka-specific functionality"""</span>
        <span class="hljs-comment"># Test partitioning, consumer groups, etc.</span>
        <span class="hljs-keyword">pass</span>
</div></code></pre>
<pre class="hljs"><code><div>
#### 7.1.2 Multi-Adapter Integration Testing (20% Coverage Target)
**Framework**: pytest with httpx for API testing and testcontainers for database isolation

```python
import pytest
from httpx import AsyncClient
from testcontainers.postgres import PostgresContainer
from testcontainers.mongodb import MongoDbContainer
from testcontainers.kafka import KafkaContainer
import os

@pytest.fixture(scope=&quot;session&quot;, params=[&quot;postgresql&quot;, &quot;mongodb&quot;])
async def test_database_adapter(request):
    &quot;&quot;&quot;Create test database adapter for different database types&quot;&quot;&quot;
    db_type = request.param

    if db_type == &quot;postgresql&quot;:
        with PostgresContainer(&quot;postgres:15&quot;) as postgres:
            connection_string = postgres.get_connection_url().replace(&quot;postgresql://&quot;, &quot;postgresql+asyncpg://&quot;)
            adapter = PostgreSQLAdapter(connection_string)
            yield adapter

    elif db_type == &quot;mongodb&quot;:
        with MongoDbContainer(&quot;mongo:6&quot;) as mongodb:
            connection_string = mongodb.get_connection_url()
            adapter = MongoDBAdapter(connection_string, &quot;test_db&quot;)
            yield adapter

@pytest.fixture(scope=&quot;session&quot;, params=[&quot;kafka&quot;, &quot;memory&quot;])
async def test_event_bus_adapter(request):
    &quot;&quot;&quot;Create test event bus adapter for different messaging systems&quot;&quot;&quot;
    event_bus_type = request.param

    if event_bus_type == &quot;kafka&quot;:
        with KafkaContainer() as kafka:
            bootstrap_servers = kafka.get_bootstrap_server()
            adapter = KafkaAdapter(bootstrap_servers, &quot;test-client&quot;)
            yield adapter

    elif event_bus_type == &quot;memory&quot;:
        # Use in-memory adapter for faster testing
        adapter = InMemoryEventBusAdapter()
        yield adapter

@pytest.mark.asyncio
async def test_submit_error_report_integration_multi_adapter(
    test_database_adapter,
    test_event_bus_adapter
):
    &quot;&quot;&quot;Integration test that works with any database and event bus adapter&quot;&quot;&quot;

    # Override dependencies with test adapters
    app.dependency_overrides[get_database_adapter] = lambda: test_database_adapter
    app.dependency_overrides[get_event_bus_adapter] = lambda: test_event_bus_adapter

    try:
        async with AsyncClient(app=app, base_url=&quot;http://test&quot;) as client:
            # Arrange
            payload = {
                &quot;job_id&quot;: &quot;550e8400-e29b-41d4-a716-446655440000&quot;,
                &quot;speaker_id&quot;: &quot;550e8400-e29b-41d4-a716-446655440001&quot;,
                &quot;original_text&quot;: &quot;The patient has diabetis&quot;,
                &quot;corrected_text&quot;: &quot;The patient has diabetes&quot;,
                &quot;error_categories&quot;: [&quot;medical_terminology&quot;],
                &quot;severity_level&quot;: &quot;high&quot;,
                &quot;start_position&quot;: 16,
                &quot;end_position&quot;: 24,
                &quot;context_notes&quot;: &quot;Common misspelling&quot;,
                &quot;metadata&quot;: {&quot;audio_quality&quot;: &quot;good&quot;}
            }

            # Act
            response = await client.post(
                &quot;/api/v1/errors/report&quot;,
                json=payload,
                headers={&quot;Authorization&quot;: &quot;Bearer test_token&quot;}
            )

            # Assert
            assert response.status_code == 201
            data = response.json()
            assert data[&quot;success&quot;] is True
            assert &quot;error_id&quot; in data[&quot;data&quot;]
            assert data[&quot;data&quot;][&quot;status&quot;] == &quot;pending&quot;

            # Verify data was saved in database (adapter-agnostic)
            error_id = data[&quot;data&quot;][&quot;error_id&quot;]
            saved_error = await test_database_adapter.find_error_by_id(error_id)
            assert saved_error is not None
            assert saved_error.original_text == payload[&quot;original_text&quot;]

    finally:
        # Clean up dependency overrides
        app.dependency_overrides.clear()

@pytest.mark.asyncio
async def test_adapter_switching_configuration():
    &quot;&quot;&quot;Test that adapters can be switched via configuration&quot;&quot;&quot;

    # Test PostgreSQL configuration
    postgres_config = DatabaseConfig(
        type=DatabaseType.POSTGRESQL,
        host=&quot;localhost&quot;,
        port=5432,
        database=&quot;test_db&quot;,
        username=&quot;test&quot;,
        password=&quot;test&quot;
    )
    postgres_adapter = await DatabaseAdapterFactory.create(postgres_config)
    assert isinstance(postgres_adapter, PostgreSQLAdapter)

    # Test MongoDB configuration
    mongodb_config = DatabaseConfig(
        type=DatabaseType.MONGODB,
        host=&quot;localhost&quot;,
        port=27017,
        database=&quot;test_db&quot;,
        username=&quot;test&quot;,
        password=&quot;test&quot;
    )
    mongodb_adapter = await DatabaseAdapterFactory.create(mongodb_config)
    assert isinstance(mongodb_adapter, MongoDBAdapter)

    # Test Kafka configuration
    kafka_config = EventBusConfig(
        type=EventBusType.KAFKA,
        connection_string=&quot;localhost:9092&quot;,
        client_id=&quot;test-client&quot;
    )
    kafka_adapter = await EventBusAdapterFactory.create(kafka_config)
    assert isinstance(kafka_adapter, KafkaAdapter)

@pytest.mark.asyncio
async def test_cross_adapter_data_consistency():
    &quot;&quot;&quot;Test that data remains consistent across different adapter implementations&quot;&quot;&quot;

    # Create test data
    error_report = ErrorReport(
        error_id=uuid4(),
        job_id=uuid4(),
        speaker_id=uuid4(),
        reported_by=uuid4(),
        original_text=&quot;test error&quot;,
        corrected_text=&quot;test correction&quot;,
        error_categories=[&quot;grammar&quot;],
        severity_level=SeverityLevel.LOW,
        start_position=0,
        end_position=10,
        error_timestamp=datetime.utcnow(),
        reported_at=datetime.utcnow()
    )

    # Test with PostgreSQL
    postgres_adapter = PostgreSQLAdapter(&quot;postgresql+asyncpg://test:test@localhost:5432/test_db&quot;)
    saved_postgres = await postgres_adapter.save_error_report(error_report)
    retrieved_postgres = await postgres_adapter.find_error_by_id(saved_postgres.error_id)

    # Test with MongoDB
    mongodb_adapter = MongoDBAdapter(&quot;mongodb://test:test@localhost:27017&quot;, &quot;test_db&quot;)
    saved_mongodb = await mongodb_adapter.save_error_report(error_report)
    retrieved_mongodb = await mongodb_adapter.find_error_by_id(saved_mongodb.error_id)

    # Assert data consistency across adapters
    assert retrieved_postgres.original_text == retrieved_mongodb.original_text
    assert retrieved_postgres.corrected_text == retrieved_mongodb.corrected_text
    assert retrieved_postgres.severity_level == retrieved_mongodb.severity_level
    assert retrieved_postgres.error_categories == retrieved_mongodb.error_categories
</div></code></pre>
<h4 id="713-contract-testing-10-coverage-target">7.1.3 Contract Testing (10% Coverage Target)</h4>
<p><strong>Framework</strong>: Pact Python for consumer-driven contract testing</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> pact <span class="hljs-keyword">import</span> Consumer, Provider, Like, Term
<span class="hljs-keyword">from</span> src.infrastructure.adapters.external.user_service_client <span class="hljs-keyword">import</span> UserServiceClient

<span class="hljs-meta">@pytest.fixture(scope="session")</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pact</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-string">"""Pact fixture for contract testing"""</span>
    <span class="hljs-keyword">return</span> Consumer(<span class="hljs-string">"error-reporting-service"</span>).has_pact_with(
        Provider(<span class="hljs-string">"user-management-service"</span>),
        host_name=<span class="hljs-string">"localhost"</span>,
        port=<span class="hljs-number">1234</span>
    )

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_validate_user_exists_contract</span><span class="hljs-params">(pact)</span>:</span>
    <span class="hljs-string">"""Contract test for user validation"""</span>
    expected = {
        <span class="hljs-string">"user_id"</span>: Like(<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>),
        <span class="hljs-string">"exists"</span>: Like(<span class="hljs-literal">True</span>),
        <span class="hljs-string">"permissions"</span>: Like([<span class="hljs-string">"error_reporting"</span>])
    }

    (pact
     .given(<span class="hljs-string">"user exists with error reporting permissions"</span>)
     .upon_receiving(<span class="hljs-string">"a request to validate user"</span>)
     .with_request(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/api/v1/users/550e8400-e29b-41d4-a716-446655440000/validate"</span>)
     .will_respond_with(<span class="hljs-number">200</span>, body=expected))

    <span class="hljs-keyword">with</span> pact:
        client = UserServiceClient(<span class="hljs-string">"http://localhost:1234"</span>)
        result = client.validate_user(<span class="hljs-string">"550e8400-e29b-41d4-a716-446655440000"</span>)
        <span class="hljs-keyword">assert</span> result[<span class="hljs-string">"exists"</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
</div></code></pre>
<h3 id="72-test-execution-strategy">7.2 Test Execution Strategy</h3>
<h4 id="721-local-development">7.2.1 Local Development</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Run unit tests</span>
pytest tests/unit/ -v --cov=src --cov-report=html

<span class="hljs-comment"># Run integration tests</span>
pytest tests/integration/ -v --tb=short

<span class="hljs-comment"># Run all tests with coverage</span>
pytest --cov=src --cov-report=html --cov-fail-under=70
</div></code></pre>
<h4 id="722-cicd-pipeline">7.2.2 CI/CD Pipeline</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># .github/workflows/test.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Test</span> <span class="hljs-string">Suite</span>
<span class="hljs-attr">on:</span> <span class="hljs-string">[push,</span> <span class="hljs-string">pull_request]</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">services:</span>
      <span class="hljs-attr">postgres:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:15</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">test</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">&gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Python</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v4</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">python-version:</span> <span class="hljs-string">'3.11'</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">|
        pip install poetry
        poetry install
</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">poetry</span> <span class="hljs-string">run</span> <span class="hljs-string">pytest</span> <span class="hljs-string">tests/unit/</span> <span class="hljs-string">--cov=src</span> <span class="hljs-string">--cov-report=xml</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">poetry</span> <span class="hljs-string">run</span> <span class="hljs-string">pytest</span> <span class="hljs-string">tests/integration/</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">coverage</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">codecov/codecov-action@v3</span>
</div></code></pre>
<hr>
<p><strong>Document Status</strong>: ✅ Complete
<strong>Next Review Date</strong>: August 14, 2025
<strong>Approval Required</strong>: Architecture Review Board, Technical Lead, Product Owner</p>
<pre class="hljs"><code><div></div></code></pre>
<pre class="hljs"><code><div></div></code></pre>
<pre class="hljs"><code><div></div></code></pre>

</body>
</html>
